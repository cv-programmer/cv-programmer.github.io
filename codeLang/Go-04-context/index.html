<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>【Go】04-context | cv-programmer</title><meta name="keywords" content="Go,context"><meta name="author" content="cv-programmer"><meta name="copyright" content="cv-programmer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Context 是什么？ Context 是 Go 中用来传递上下文信息的一种方式，要用来在 goroutine 之间传递上下文信息，包括：取消信号、超时时间、截止时间、k-v 等 常见场景：当作为 server 处理 client 信息时，client 异常关闭之后，server 应该同步终止 client 之前的请求资源，即 gracefully terminate（这样server能够节省资">
<meta property="og:type" content="article">
<meta property="og:title" content="【Go】04-context">
<meta property="og:url" content="http://bh.ecel.top/codeLang/Go-04-context/index.html">
<meta property="og:site_name" content="cv-programmer">
<meta property="og:description" content="Context 是什么？ Context 是 Go 中用来传递上下文信息的一种方式，要用来在 goroutine 之间传递上下文信息，包括：取消信号、超时时间、截止时间、k-v 等 常见场景：当作为 server 处理 client 信息时，client 异常关闭之后，server 应该同步终止 client 之前的请求资源，即 gracefully terminate（这样server能够节省资">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://bh.ecel.top/image/go.jpeg">
<meta property="article:published_time" content="2024-04-04T11:19:17.000Z">
<meta property="article:modified_time" content="2024-08-31T14:32:14.288Z">
<meta property="article:author" content="cv-programmer">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="context">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://bh.ecel.top/image/go.jpeg"><link rel="shortcut icon" href="/image/avatar.jpg"><link rel="canonical" href="http://bh.ecel.top/codeLang/Go-04-context/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":10,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-31 22:32:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/image/avatar.jpg" onerror="onerror=null;src='/image/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">115</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/go.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">cv-programmer</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【Go】04-context</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-04T11:19:17.000Z" title="发表于 2024-04-04 19:19:17">2024-04-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-31T14:32:14.288Z" title="更新于 2024-08-31 22:32:14">2024-08-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Context-是什么？"><a href="#Context-是什么？" class="headerlink" title="Context 是什么？"></a>Context 是什么？</h1><ul>
<li>Context 是 Go 中用来<strong>传递上下文信息的一种方式</strong>，要用来在 goroutine 之间传递上下文信息，包括：取消信号、超时时间、截止时间、k-v 等</li>
<li>常见场景：当作为 server 处理 client 信息时，client 异常关闭之后，server 应该同步终止 client 之前的请求资源，即 <code>gracefully terminate</code>（这样server能够节省资源，不处理 client 多余的请求，毕竟 client 已经异常关闭）</li>
</ul>
<h1 id="Context-如何使用？"><a href="#Context-如何使用？" class="headerlink" title="Context 如何使用？"></a>Context 如何使用？</h1><h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;Doing something!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.TODO()</span><br><span class="line">	doSomething(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过调用 <code>context</code> 包来创建一个 context，用来传递信息</li>
<li>也可以使用 <code>ctx := context.Background()</code>，两者的差异可见[<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/74239074/context-todo-or-context-background-which-one-should-i-prefer">context.TODO() or context.Background(), which one should I prefer?</a>。两者本质一致，差异在于使用 <code>TODO</code>用来表示不确定性，后续要变更。<code>Background()</code>则更为明确</li>
</ul>
<h2 id="传递变量"><a href="#传递变量" class="headerlink" title="传递变量"></a>传递变量</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;doSomething: myKey&#x27;s value is %s\n&quot;</span>, ctx.Value(<span class="string">&quot;myKey&quot;</span>))</span><br><span class="line"></span><br><span class="line">	anotherCtx := context.WithValue(ctx, <span class="string">&quot;myKey&quot;</span>, <span class="string">&quot;anotherValue&quot;</span>)</span><br><span class="line">	doAnother(anotherCtx)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;doSomething: myKey&#x27;s value is %s\n&quot;</span>, ctx.Value(<span class="string">&quot;myKey&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doAnother</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;doAnother: myKey&#x27;s value is %s\n&quot;</span>, ctx.Value(<span class="string">&quot;myKey&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	ctx = context.WithValue(ctx, <span class="string">&quot;myKey&quot;</span>, <span class="string">&quot;myValue&quot;</span>)</span><br><span class="line"></span><br><span class="line">	doSomething(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// doSomething: myKey&#x27;s value is myValue</span></span><br><span class="line"><span class="comment">// doAnother: myKey&#x27;s value is anotherValue</span></span><br><span class="line"><span class="comment">// doSomething: myKey&#x27;s value is myValue</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过 <code>context</code>可以用来传递参数，此时可在调用链中继续使用，注意使用场景，简而言之，<strong>就是不要滥用，下面给出了一个注意点</strong></p>
<blockquote>
<p> Contexts can be a powerful tool with all the values they can hold, but a balance needs to be struck between data being stored in a context and data being passed to a function as parameters. It may seem tempting to put all of your data in a context and use that data in your functions instead of parameters, but that can lead to code that is hard to read and maintain. A good rule of thumb is that any data required for a function to run should be passed as parameters. Sometimes, for example, it can be useful to keep values such as usernames in context values for use when logging information for later. However, if the username is used to determine if a function should display some specific information, you’d want to include it as a function parameter even if it’s already available from the context. This way when you, or someone else, looks at the function in the future, it’s easier to see which data is actually being used.</p>
</blockquote>
</li>
<li><p>context 传递变量时，同一个函数中，值不会被改变</p>
</li>
</ul>
<h2 id="通过-语义-终止运行-同步信号（context-WithCancel）"><a href="#通过-语义-终止运行-同步信号（context-WithCancel）" class="headerlink" title="通过 语义 终止运行&#x2F;同步信号（context.WithCancel）"></a>通过 语义 终止运行&#x2F;同步信号（context.WithCancel）</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	ctx, cancelCtx := context.WithCancel(ctx)</span><br><span class="line">	</span><br><span class="line">	printCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">go</span> doAnother(ctx, printCh)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num := <span class="number">1</span>; num &lt;= <span class="number">3</span>; num++ &#123;</span><br><span class="line">		printCh &lt;- num</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cancelCtx()</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;doSomething: finished\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doAnother</span><span class="params">(ctx context.Context, printCh &lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">if</span> err := ctx.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;doAnother err: %s\n&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;doAnother: finished\n&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> num := &lt;-printCh:</span><br><span class="line">			fmt.Printf(<span class="string">&quot;doAnother: %d\n&quot;</span>, num)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output</span></span><br><span class="line"><span class="comment">// doAnother: 1</span></span><br><span class="line"><span class="comment">// doAnother: 2</span></span><br><span class="line"><span class="comment">// doAnother: 3</span></span><br><span class="line"><span class="comment">// doAnother err: context canceled</span></span><br><span class="line"><span class="comment">// doAnother: finished</span></span><br><span class="line"><span class="comment">// doSomething: finished</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过向 channel 传递消息，来决定是否终止后续运行。逐步传递，保证上层 Goroutine 执行出现错误时，将信号及时同步给下层</li>
<li><code>ctx.Done()</code>被执行，说明已到达设定的终止语义</li>
</ul>
<h2 id="通过-终止时间-终止运行"><a href="#通过-终止时间-终止运行" class="headerlink" title="通过 终止时间 终止运行"></a>通过 终止时间 终止运行</h2><h3 id="context-WithDeadline"><a href="#context-WithDeadline" class="headerlink" title="context.WithDeadline"></a>context.WithDeadline</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	deadline := time.Now().Add(<span class="number">1500</span> * time.Millisecond)</span><br><span class="line">	ctx, cancelCtx := context.WithDeadline(ctx, deadline)</span><br><span class="line">	<span class="keyword">defer</span> cancelCtx()</span><br><span class="line"></span><br><span class="line">	printCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">go</span> doAnother(ctx, printCh)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num := <span class="number">1</span>; num &lt;= <span class="number">3</span>; num++ &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> printCh &lt;- num:</span><br><span class="line">			time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cancelCtx()</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;doSomething: finished\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过指定超时时间，来决定是否终止后续运行。如果超时，则会自动终止调用</p>
</li>
<li><p>同时使用 <code>defer cancelCtx()</code> 和 <code>cancelCtx()</code>原因: 后者是主动调用，没有回收一些资源（因为写的是 break），前者是更加安全的方式</p>
<blockquote>
<p>The <code>defer cancelCtx()</code> isn’t necessarily required because the other call will always be run, but it can be useful to keep it in case there are any <code>return</code> statements in the future that cause it to be missed. When a context is canceled from a deadline, the cancel function is still required to be called in order to clean up any resources that were used, so this is more of a safety measure.</p>
</blockquote>
</li>
</ul>
<h3 id="context-WithTimeout"><a href="#context-WithTimeout" class="headerlink" title="context.WithTimeout"></a>context.WithTimeout</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	ctx, cancelCtx := context.WithTimeout(ctx, <span class="number">1500</span>*time.Millisecond)</span><br><span class="line">	<span class="keyword">defer</span> cancelCtx()</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>简化使用</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-use-contexts-in-go">How To Use Contexts in Go</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@jamal.kaksouri/the-complete-guide-to-context-in-golang-efficient-concurrency-management-43d722f6eaea">The Complete Guide to Context in Golang: Efficient Concurrency Management</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68792989">深度解密Go语言之context</a></li>
<li><a target="_blank" rel="noopener" href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/#61-%e4%b8%8a%e4%b8%8b%e6%96%87-context">Go 语言设计与实现 6.1 上下文 Context</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">cv-programmer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://bh.ecel.top/codeLang/Go-04-context/">http://bh.ecel.top/codeLang/Go-04-context/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://bh.ecel.top" target="_blank">cv-programmer</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Go/">Go</a><a class="post-meta__tags" href="/tags/context/">context</a></div><div class="post_share"><div class="social-share" data-image="/image/go.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/tools/The-trick-of-ansible/"><img class="prev-cover" src="/image/ansible.png" onerror="onerror=null;src='/image/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ansible 使用说明</div></div></a></div><div class="next-post pull-right"><a href="/cloud/harbor-04-registry/"><img class="next-cover" src="/image/harbor-horizontal-color.png" onerror="onerror=null;src='/image/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【Harbor】04-registry</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/codeLang/Go-01-basic-concept/" title="【Go】01-基础概念"><img class="cover" src="/image/go.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-25</div><div class="title">【Go】01-基础概念</div></div></a></div><div><a href="/codeLang/Go-03-gin/" title="【Go】03-Gin"><img class="cover" src="/image/go.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-30</div><div class="title">【Go】03-Gin</div></div></a></div><div><a href="/codeLang/Go-02-escape-analysis/" title="【Go】02-逃逸分析(escape analysis)——未完"><img class="cover" src="/image/go.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-17</div><div class="title">【Go】02-逃逸分析(escape analysis)——未完</div></div></a></div><div><a href="/codeLang/Go-05-goroutine/" title="【Go】05-goroutine"><img class="cover" src="/image/go.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-03</div><div class="title">【Go】05-goroutine</div></div></a></div><div><a href="/tutorial/Linux-install-Go-in-Linux/" title="【Linux】Go安装"><img class="cover" src="/image/linux.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">【Linux】Go安装</div></div></a></div><div><a href="/tutorial/Windows-install-Go-in-Windows/" title="【Windows】Go安装"><img class="cover" src="/image/windows.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">【Windows】Go安装</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/image/avatar.jpg" onerror="this.onerror=null;this.src='/image/friend_404.gif'" alt="avatar"/><div class="author-info__name">cv-programmer</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">115</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cv-programmer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cv-programmer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:usetologin@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Context-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">Context 是什么？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Context-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">Context 如何使用？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">基础用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.</span> <span class="toc-text">传递变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-%E8%AF%AD%E4%B9%89-%E7%BB%88%E6%AD%A2%E8%BF%90%E8%A1%8C-%E5%90%8C%E6%AD%A5%E4%BF%A1%E5%8F%B7%EF%BC%88context-WithCancel%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">通过 语义 终止运行&#x2F;同步信号（context.WithCancel）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-%E7%BB%88%E6%AD%A2%E6%97%B6%E9%97%B4-%E7%BB%88%E6%AD%A2%E8%BF%90%E8%A1%8C"><span class="toc-number">2.4.</span> <span class="toc-text">通过 终止时间 终止运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#context-WithDeadline"><span class="toc-number">2.4.1.</span> <span class="toc-text">context.WithDeadline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#context-WithTimeout"><span class="toc-number">2.4.2.</span> <span class="toc-text">context.WithTimeout</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/web3/what-is-blockchain/" title="区块链简易 demo"><img src="/image/blockchain.jpg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="区块链简易 demo"/></a><div class="content"><a class="title" href="/web3/what-is-blockchain/" title="区块链简易 demo">区块链简易 demo</a><time datetime="2024-12-14T12:39:20.000Z" title="发表于 2024-12-14 20:39:20">2024-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/tutorial/cf-worker/" title="CF worker 使用"><img src="/image/docker.jpg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="CF worker 使用"/></a><div class="content"><a class="title" href="/tutorial/cf-worker/" title="CF worker 使用">CF worker 使用</a><time datetime="2024-09-22T02:03:26.000Z" title="发表于 2024-09-22 10:03:26">2024-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/tutorial/Makefile-with-ops/" title="Makefile 简化运维操作"><img src="/image/gnu.png" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="Makefile 简化运维操作"/></a><div class="content"><a class="title" href="/tutorial/Makefile-with-ops/" title="Makefile 简化运维操作">Makefile 简化运维操作</a><time datetime="2024-09-20T10:11:52.000Z" title="发表于 2024-09-20 18:11:52">2024-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/tutorial/div-miniserver/" title="Div 迷你主机"><img src="/image/linux.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="Div 迷你主机"/></a><div class="content"><a class="title" href="/tutorial/div-miniserver/" title="Div 迷你主机">Div 迷你主机</a><time datetime="2024-09-18T14:51:48.000Z" title="发表于 2024-09-18 22:51:48">2024-09-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cloud/docker-01-docker-build-secret/" title="【Docker】01-构建时 secret 处理"><img src="/image/docker.jpg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Docker】01-构建时 secret 处理"/></a><div class="content"><a class="title" href="/cloud/docker-01-docker-build-secret/" title="【Docker】01-构建时 secret 处理">【Docker】01-构建时 secret 处理</a><time datetime="2024-08-17T07:37:36.000Z" title="发表于 2024-08-17 15:37:36">2024-08-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/image/go.jpeg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By cv-programmer</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>