<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>【k8s】02-快速入门 | cv-programmer</title><meta name="keywords" content="云原生,k8s,kubernetes"><meta name="author" content="cv-programmer"><meta name="copyright" content="cv-programmer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="概述本文旨在利用简单的 web-db 服务，串接 k8s 相关知识 配置 本文采用 kind 搭建测试 k8s 集群  kind 部署 kubernetes 群集相当方便，可以快速部署多个群集。但在群集的配置和更新上有明显弊端，只能通过重新创建群集来配置和更新群集。所以在初始化群集的时候需要考虑好配置选项。当然我们只是用于测试环境，也无大碍   采用 VMware® Workstation 17">
<meta property="og:type" content="article">
<meta property="og:title" content="【k8s】02-快速入门">
<meta property="og:url" content="http://bh.ecel.top/cloud/k8s-02-quickly-start/index.html">
<meta property="og:site_name" content="cv-programmer">
<meta property="og:description" content="概述本文旨在利用简单的 web-db 服务，串接 k8s 相关知识 配置 本文采用 kind 搭建测试 k8s 集群  kind 部署 kubernetes 群集相当方便，可以快速部署多个群集。但在群集的配置和更新上有明显弊端，只能通过重新创建群集来配置和更新群集。所以在初始化群集的时候需要考虑好配置选项。当然我们只是用于测试环境，也无大碍   采用 VMware® Workstation 17">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://bh.ecel.top/image/k8s.png">
<meta property="article:published_time" content="2024-06-23T05:04:27.000Z">
<meta property="article:modified_time" content="2024-08-31T14:32:14.074Z">
<meta property="article:author" content="cv-programmer">
<meta property="article:tag" content="云原生">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://bh.ecel.top/image/k8s.png"><link rel="shortcut icon" href="/image/avatar.jpg"><link rel="canonical" href="http://bh.ecel.top/cloud/k8s-02-quickly-start/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":10,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-31 22:32:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/image/avatar.jpg" onerror="onerror=null;src='/image/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">120</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/k8s.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">cv-programmer</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【k8s】02-快速入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-23T05:04:27.000Z" title="发表于 2024-06-23 13:04:27">2024-06-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-31T14:32:14.074Z" title="更新于 2024-08-31 22:32:14">2024-08-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>本文旨在利用简单的 web-db 服务，串接 k8s 相关知识</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li><p>本文采用 <a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/">kind</a> 搭建测试 k8s 集群</p>
<blockquote>
<p>kind 部署 kubernetes 群集相当方便，可以快速部署多个群集。但在群集的配置和更新上有明显弊端，<strong>只能通过重新创建群集来配置和更新群集</strong>。所以在初始化群集的时候需要考虑好配置选项。当然我们只是用于测试环境，也无大碍</p>
</blockquote>
</li>
<li><p>采用 VMware® Workstation 17 Pro 及 <del>CentOS-7-x86_64-Minimal-2009</del> AlmaLinux-9.4-x86_64-minimal （centos7 坑有点多，并且不再维护，所以后续使用 almalinux） 作为基础环境</p>
</li>
</ul>
<h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><ol>
<li><p>采用最简单的方式，下载编译后的二进制包，可见 <a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/quick-start/#installing-from-release-binaries">Installing From Release Binaries</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ $(uname -m) = x86_64 ] &amp;&amp; curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64</span><br><span class="line">chmod +x ./kind</span><br><span class="line">sudo mv ./kind /usr/bin/kind</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 docker</p>
<ol>
<li><p>在 <code>/etc/yum.repo.d</code> 中新增 docker 源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -o /etc/yum.repo.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装: <code>sudo yum install docker-ce-24.0.7</code></p>
</li>
<li><p>配置 docker mirror，修改 <code>/etc/docker/daemon.json</code>，加入以下，参考 <a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv35624216/?jump_opus=1">零门槛最简单国内访问Docker Hub的替代方案</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [</span><br><span class="line">        &quot;https://docker.m.daocloud.io&quot;,</span><br><span class="line">        &quot;https://huecker.io&quot;,</span><br><span class="line">        &quot;https://dockerhub.timeweb.cloud&quot;,</span><br><span class="line">        &quot;https://noohub.ru&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>安装 kubectl，可见 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">Install and Set Up kubectl on Linux</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span><br><span class="line">sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><br></pre></td></tr></table></figure>
</li>
<li><p>搭建测试集群：<code>kind create cluster --config kind-example-config.yaml --name example</code>，如果失败，重试即可（失败可能是虚拟机资源不够）</p>
<ul>
<li><p>配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">this config file contains all config fields with comments</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NOTE: this is not a particularly useful config file</span></span><br><span class="line">kind: Cluster</span><br><span class="line">apiVersion: kind.x-k8s.io/v1alpha4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">patch the generated kubeadm config with some extra settings</span></span><br><span class="line">kubeadmConfigPatches:</span><br><span class="line">- |</span><br><span class="line">  apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">  kind: KubeletConfiguration</span><br><span class="line">  evictionHard:</span><br><span class="line">    nodefs.available: &quot;0%&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">patch it further using a JSON 6902 patch</span></span><br><span class="line">kubeadmConfigPatchesJSON6902:</span><br><span class="line">- group: kubeadm.k8s.io</span><br><span class="line">  version: v1beta2</span><br><span class="line">  kind: ClusterConfiguration</span><br><span class="line">  patch: |</span><br><span class="line">    - op: add</span><br><span class="line">      path: /apiServer/certSANs/-</span><br><span class="line">      value: my-hostname</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1 control plane node and 3 workers</span></span><br><span class="line">nodes:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the control plane node config</span></span><br><span class="line">- role: control-plane</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the three workers</span></span><br><span class="line">- role: worker</span><br><span class="line">- role: worker</span><br><span class="line">- role: worker</span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240721181705648.png" alt="image-20240721181705648"></p>
</li>
<li><p>切换为该集群，并查看 node 信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info --context kind-example</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240721180936929.png" alt="image-20240721180936929"></p>
</li>
</ul>
</li>
</ol>
<h1 id="web-db"><a href="#web-db" class="headerlink" title="web-db"></a>web-db</h1><h2 id="版本1——Pod"><a href="#版本1——Pod" class="headerlink" title="版本1——Pod"></a>版本1——Pod</h2><ul>
<li><p>由于本文的目的是搭建一个带有 DB 的 web，因此简易版本需要两个镜像 <code>nginx:latest</code> 和 <code>mysql:latest</code></p>
</li>
<li><p>由于 kind 不推荐使用 latest 标签（可见 [pod 报错 ErrImagePull 或 ImagePullBackOff](##pod 报错 ErrImagePull 或 ImagePullBackOff)），因此使用以下重命名 tag</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag nginx:latest nginx:v1.27.0</span><br><span class="line">docker tag mysql:latest mysql:v9.0.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于 kind 特性，需要将 image 加载到 cluster 中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind load docker-image nginx:v1.27.0 mysql:v9.0.1 --name example1</span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240727190751229.png" alt="image-20240727190751229"></p>
</li>
<li><p>可以通过 <code>docker exec -it example-worker crictl images</code> 查看某个 node 已加载的 image 信息</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727190342358.png" alt="image-20240727190342358"></p>
</li>
<li><p>编辑文件<code>webapp-with-db-pod.yaml</code> 并执行: <code>kubectl apply -f webapp-with-db-pod.yaml</code>，即可生成一个 pod，其中含有两个 container</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240727190833304.png" alt="image-20240727190833304"></p>
</li>
<li><p>通过 <code>kubectl get pods</code> 可查看 pod 状态，<code>kubectl get pods -o yaml</code> 查看更详细信息。<font color="red">一段时间后，发现 pod 状态异常</font>，通过以下指令一步步定位问题</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727213828657.png" alt="image-20240727213828657"></p>
<ol>
<li><p>通过 <code>kubectl get pods -o yaml</code> 查看更多的信息，没有发现根本原因</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727213903969.png" alt="image-20240727213903969"></p>
</li>
<li><p>查看 event: <code>kubectl get events -o yaml</code>，也没有发现更多信息</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727214304441.png" alt="image-20240727214304441"></p>
</li>
<li><p>查看 pod 中 database 容器日志：<code>kubectl logs webapp-with-db -c database</code>。</p>
<ol>
<li><p><font color="red">可以发现，MySQL 需要以下环境变量才可以正常启动</font></p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727214359820.png" alt="image-20240727214359820"></p>
</li>
<li><p>临时解决办法是使用以下 yaml 重新 apply，注意 value 需要使用 string（需删除之前的 pod）。<font color="red">后续版本有更安全的方式</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果不删除之前的 pod，报错如下</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727215051128.png" alt="image-20240727215051128"></p>
</li>
</ol>
</li>
</ol>
</li>
</ul>
<h2 id="版本2——Service（集群内服务提供）"><a href="#版本2——Service（集群内服务提供）" class="headerlink" title="版本2——Service（集群内服务提供）"></a>版本2——Service（集群内服务提供）</h2><ul>
<li><p>版本1已经成功生成了一个 pod，但是<strong>外界无法访问该服务</strong>，因此引入 k8s 中 <code>service</code> 概念，将 Pod 提供的服务暴露给集群内部</p>
<blockquote>
<p>It allows you to expose your application to other pods within the cluster or to external clients. Services provide load balancing and automatic scaling for the pods behind them, ensuring that the application remains highly available.</p>
</blockquote>
</li>
<li><p>更新 yaml 为以下内容，重新执行 <code>kubectl apply -f webapp-with-db-pod.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240727220711554.png" alt="image-20240727220711554"></p>
</li>
<li><p>与上个版本 diff 如下</p>
</li>
<li><p><strong>此时服务只在集群中可被访问</strong>，重新起一个 pod 用于测试连通性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">db-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-test</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123&quot;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>通过 <code> kubectl get services</code> 拿到 webapp-service 的 cluster ip</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240727223706053.png" alt="image-20240727223706053"></p>
</li>
<li><p>进入新 pod，测试服务连通性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">kubectl exec -it db-test -- bash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以通过 curl http://webapp-service 测试</span></span><br><span class="line">curl http://IP:80</span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240727224711219.png" alt="image-20240727224711219"></p>
</li>
</ol>
</li>
</ul>
<h2 id="版本3——Service（集群外服务提供）"><a href="#版本3——Service（集群外服务提供）" class="headerlink" title="版本3——Service（集群外服务提供）"></a>版本3——Service（集群外服务提供）</h2><h3 id="nodeport"><a href="#nodeport" class="headerlink" title="nodeport"></a>nodeport</h3><ul>
<li><p>版本2 已经提供了一个集群内可供访问的服务，但是<strong>集群外无法访问服务</strong>，可以通过 nodeport 的方式对外提供服务</p>
</li>
<li><p>更新 yaml 为以下内容，重新执行 <code>kubectl apply -f webapp-with-db-pod.yaml</code>。其中 IP 为 pod 所在 node IP（任意一个即可），可以通过 <code> kubectl get nodes -o wide</code> 查看 nodeip，即 INTERNAL-IP</p>
<blockquote>
<p>在 Kubernetes 中，当你使用 <code>NodePort</code> 类型的 Service 时，这个 Service 将会在集群中的每个节点上监听一个相同的端口，并将流量转发到对应的 Pod。这就是为什么你可以通过任意一个节点的 IP 地址和指定的 NodePort 访问到服务，即使 Pod 并不在所有节点上。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240728102216756.png" alt="image-20240728102216756"></p>
</li>
<li><p>与上个版本 diff 如下</p>
</li>
<li><p>nodeport 和 targetport 区别</p>
<ul>
<li><strong>NodePort</strong>：<ul>
<li>用于在集群外暴露 Service</li>
<li>在每个节点上打开一个固定的端口，用于接收外部流量</li>
<li>外部客户端可以通过节点的 IP 地址和 NodePort 访问 Service</li>
</ul>
</li>
<li><strong>targetPort</strong>：<ul>
<li>用于定义 Service 转发流量到 Pod 的哪个端口</li>
<li>是 Pod 内容器暴露的端口</li>
<li>定义了 Service 如何将流量路由到 Pod 内容器</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h3><ul>
<li><p>ingress 是另一种暴露服务的方式，与 nodeport 区别如下</p>
<ul>
<li><strong>Ingress</strong> 是一种高级的资源，用于在集群外部暴露服务，支持主机和路径匹配、TLS 终止等功能，需要配合 Ingress Controller 使用。</li>
<li><strong>NodePort</strong> 是一种简单的方式，将服务暴露到所有节点上的一个固定端口，可以通过节点的 IP 地址和指定的端口访问服务，无需额外的 Ingress Controller</li>
</ul>
</li>
<li><p>具体实现后续再做，可参考</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/ingress/">Ingress</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7353543714152087591">KIND安装本地K8S集群并通过Ingress访问Pod</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/vl7SZGQc2JUaM6IisAhE">入门级实操教程！从概念到部署，全方位了解 K8S Ingress！</a></li>
</ul>
</li>
</ul>
<h2 id="版本4——ConfigMap"><a href="#版本4——ConfigMap" class="headerlink" title="版本4——ConfigMap"></a>版本4——ConfigMap</h2><ul>
<li><p>版本3 已经成功将 Pod 中的服务提供给外部访问，但是如果需要更新 pod 中配置文件或者环境变量，应该怎么做？</p>
</li>
<li><p>k8s 提供了 <code>ConfigMap</code> 的概念，<strong>用于存储配置文件信息</strong></p>
<blockquote>
<p>A Kubernetes <code>ConfigMap</code> is used to store configuration data that can be consumed by pods as environment variables or mounted as configuration files. It helps separate the configuration from the container image, making it easier to update configurations without rebuilding the container.</p>
</blockquote>
</li>
<li><p>配置如下</p>
<ul>
<li><p>新增了 <code>ConfigMap</code> 配置 <code>webapp-config</code></p>
</li>
<li><p>webapp 通过 <code>envFrom </code>引用了 <code>webapp-config</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">WEBAPP_ENV:</span> <span class="string">&quot;production&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>直接修改后 apply 报错如下 &#x3D;&gt; 解决：删除现有 pod，重新 apply（如果是 deployment 或者 replicaset 只需要删除，k8s 会自动重建）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">service/webapp-service unchanged</span><br><span class="line">configmap/webapp-config created</span><br><span class="line">The Pod &quot;webapp-with-db&quot; is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`,`spec.initContainers[*].image`,`spec.activeDeadlineSeconds`,`spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)</span><br><span class="line">  core.PodSpec&#123;</span><br><span class="line">        Volumes:        &#123;&#123;Name: &quot;kube-api-access-85btk&quot;, VolumeSource: &#123;Projected: &amp;&#123;Sources: &#123;&#123;ServiceAccountToken: &amp;&#123;ExpirationSeconds: 3607, Path: &quot;token&quot;&#125;&#125;, &#123;ConfigMap: &amp;&#123;LocalObjectReference: &#123;Name: &quot;kube-root-ca.crt&quot;&#125;, Items: &#123;&#123;Key: &quot;ca.crt&quot;, Path: &quot;ca.crt&quot;&#125;&#125;&#125;&#125;, &#123;DownwardAPI: &amp;&#123;Items: &#123;&#123;Path: &quot;namespace&quot;, FieldRef: &amp;&#123;APIVersion: &quot;v1&quot;, FieldPath: &quot;metadata.namespace&quot;&#125;&#125;&#125;&#125;&#125;&#125;, DefaultMode: &amp;420&#125;&#125;&#125;&#125;,</span><br><span class="line">        InitContainers: nil,</span><br><span class="line">        Containers: []core.Container&#123;</span><br><span class="line">                &#123;</span><br><span class="line">                        ... // 4 identical fields</span><br><span class="line">                        WorkingDir: &quot;&quot;,</span><br><span class="line">                        Ports:      &#123;&#123;ContainerPort: 80, Protocol: &quot;TCP&quot;&#125;&#125;,</span><br><span class="line">-                       EnvFrom:    nil,</span><br><span class="line">+                       EnvFrom: []core.EnvFromSource&#123;</span><br><span class="line">+                               &#123;</span><br><span class="line">+                                       ConfigMapRef: &amp;core.ConfigMapEnvSource&#123;LocalObjectReference: core.LocalObjectReference&#123;...&#125;&#125;,</span><br><span class="line">+                               &#125;,</span><br><span class="line">+                       &#125;,</span><br><span class="line">                        Env:       nil,</span><br><span class="line">                        Resources: &#123;&#125;,</span><br><span class="line">                        ... // 15 identical fields</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;Name: &quot;database&quot;, Image: &quot;mysql:v9.0.1&quot;, Env: &#123;&#123;Name: &quot;MYSQL_ROOT_PASSWORD&quot;, Value: &quot;123&quot;&#125;&#125;, VolumeMounts: &#123;&#123;Name: &quot;kube-api-access-85btk&quot;, ReadOnly: true, MountPath: &quot;/var/run/secrets/kubernetes.io/serviceaccount&quot;&#125;&#125;, ...&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        EphemeralContainers: nil,</span><br><span class="line">        RestartPolicy:       &quot;Always&quot;,</span><br><span class="line">        ... // 28 identical fields</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>原因：向已经运行的 Pod 添加 ConfigMap 是不支持的。ConfigMap 是 Kubernetes 中用于存储非敏感数据的对象，用于配置应用程序、存储环境变量等。<strong>当一个 Pod 创建时，它会使用 ConfigMap 中的数据或者环境变量，但是一旦 Pod 已经创建并且在运行中，就不能直接修改它的配置或环境变量</strong></li>
<li>如果你需要在一个正在运行的 Pod 中更新配置，你有几种选择：<ol>
<li><strong>重新启动 Pod</strong>：<ul>
<li>最简单的方法是重新启动 Pod。你可以更新 Pod 配置文件，将新的 ConfigMap 引入到 Pod 的配置中，然后删除现有的 Pod，Kubernetes 会自动创建一个新的 Pod，并使用更新后的配置。</li>
</ul>
</li>
<li><strong>使用 Sidecar 容器</strong>：<ul>
<li>你可以在需要更新配置的 Pod 中添加一个 Sidecar 容器，这个 Sidecar 容器负责监视 ConfigMap 的变化，并将更新后的配置传递给主要的应用程序容器。</li>
</ul>
</li>
<li><strong>使用 Init 容器</strong>：<ul>
<li>另一种方法是使用 Init 容器。你可以在 Pod 中添加一个 Init 容器，这个容器可以在主要应用程序容器启动之前获取最新的配置，并将其传递给主要应用程序容器。</li>
</ul>
</li>
<li><strong>使用动态配置</strong>：<ul>
<li>一些应用程序支持动态地重新加载配置，而不需要重新启动。如果你的应用程序支持动态配置加载，你可以更新 ConfigMap，然后通知应用程序重新加载配置。</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li><p>通过 <code>kubectl exec -it webapp-with-db -c webapp -- bash</code> 查看 env 可以发现多了一个环境变量</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240728120149792.png" alt="image-20240728120149792"></p>
</li>
<li><p>如果此时修改 WEBAPP_ENV 的值，通过 <code>kubectl describe configmap webapp-config</code> 可以发现值已经变量，<font color="color">但是再次进入容器内，可以发现值没有发生变化</font>，是因为 在 Kubernetes 中，Pod 中使用 ConfigMap 设置的环境变量<strong>通常需要 Pod 重启才能加载新的值</strong>。这是因为当 Pod 启动时，它会获取 ConfigMap 中的值并将其转换为环境变量。<strong>如果在运行时更新了 ConfigMap 中的数据，Pod 中的容器并不会自动获取到这些更新后的值，除非 Pod 重新启动</strong></p>
</li>
<li><p>如果希望不重启修改能生效，可以采用以下方案</p>
<ul>
<li><strong>使用 Sidecar 容器</strong>：添加一个 Sidecar 容器，这个容器可以监视 ConfigMap 的变化并更新主要应用程序容器的环境变量。</li>
<li><strong>使用 Init 容器</strong>：引入一个 Init 容器，它可以在主要应用程序容器启动之前获取最新的配置，并将其传递给主要应用程序容器。</li>
<li><strong>应用程序支持动态更新</strong>：有些应用程序支持动态地重新加载配置，可以在配置发生变化时主动更新环境变量，而不需要重启应用程序</li>
</ul>
</li>
</ul>
<h2 id="版本5——Secret"><a href="#版本5——Secret" class="headerlink" title="版本5——Secret"></a>版本5——Secret</h2><ul>
<li><p>版本4 已经能够满足配置文件的存储需要了，但是敏感信息直接使用 ConfigMap 安全性不够</p>
</li>
<li><p>k8s 提供了 <code>Secret</code> 的概念，<strong>用于存储敏感信息</strong></p>
<blockquote>
<p>Kubernetes <code>Secrets</code> are used to store sensitive information, such as passwords, API keys, or TLS certificates. Secrets are base64-encoded by default and can be mounted as files or used as environment variables in pods.</p>
</blockquote>
</li>
<li><p>将 MYSQL_ROOT_PASSWORD 放入 secret，其中 yaml 中填写的值是 base64 处理后的结果，<code>type: Opaque</code> 表示 Secret 中的数据是一个字典，其中包含了任意类型的键值对数据。这意味着在 Opaque Secret 中，可以存储任何类型的数据，例如密码、证书、Token 等，而这些数据以 base64 编码的形式存储在 Secret 对象中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">WEBAPP_ENV:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIz</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="版本6——Volume"><a href="#版本6——Volume" class="headerlink" title="版本6——Volume"></a>版本6——Volume</h2><ul>
<li><p>以上版本，实现了配置文件和敏感信息的写入，但是对于 DB <strong>数据的持久化还没有实现</strong>，并且<strong>Pod 中不同容器间也无法共享数据</strong></p>
</li>
<li><p>k8s 提供了 <code>Volume</code> 的概念，<strong>用于存储数据持久化和数据共享</strong></p>
<blockquote>
<p>A Kubernetes <code>Volume</code> is a directory that is accessible to all containers in a pod. It decouples the storage from the containers, ensuring that data persists even if a container is restarted or rescheduled.</p>
</blockquote>
</li>
<li><p>以下使用 <code>PersistentVolumeClaim</code> 用于请求持久存储资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-with-db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-data</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">database-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">WEBAPP_ENV:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIz</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">database-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Mi</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可以通过 <code>kubectl get pvc</code> 查看 PVC 的状态</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240728145240123.png" alt="image-20240728145240123"></p>
</li>
<li><p>可以通过以下方式验证 PVC 的有效性</p>
<ol>
<li><p>生成 pod，进入 database，创建数据库和数据表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f webapp-with-db-pod.yaml</span><br><span class="line"></span><br><span class="line">create database hello;</span><br><span class="line">use hello;</span><br><span class="line">CREATE TABLE students (</span><br><span class="line">    id INT AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    name VARCHAR(50) NOT NULL,</span><br><span class="line">    age INT,</span><br><span class="line">    gender ENUM(&#x27;Male&#x27;, &#x27;Female&#x27;, &#x27;Other&#x27;),</span><br><span class="line">    grade FLOAT</span><br><span class="line">);</span><br><span class="line">INSERT INTO students (name, age, gender, grade) VALUES</span><br><span class="line">(&#x27;Alice&#x27;, 20, &#x27;Female&#x27;, 85.5),</span><br><span class="line">(&#x27;Bob&#x27;, 22, &#x27;Male&#x27;, 78.3),</span><br><span class="line">(&#x27;Charlie&#x27;, 21, &#x27;Male&#x27;, 92.0);</span><br></pre></td></tr></table></figure>
</li>
<li><p>销毁 pod: <code>kubectl delete po webapp-with-db</code></p>
</li>
<li><p>重新生成 pod，进入 database，查看数据是否存在</p>
</li>
</ol>
</li>
</ul>
<h2 id="版本7——deployment"><a href="#版本7——deployment" class="headerlink" title="版本7——deployment"></a>版本7——deployment</h2><ul>
<li><p>上述版本已经较好的实现了一个服务从启动、对外提供服务、配置信息和敏感信息存储，已经数据持久化工作。但是<strong>当 pod 异常退出时，目前没有自愈能力，包括流量变化时，也没有扩缩容能力</strong></p>
</li>
<li><p>k8s 提供了 <code>Deployment</code> 的概念，<strong>用于无状态应用的生命周期管理</strong></p>
<blockquote>
<p>A Kubernetes <code>Deployment</code> is a higher-level abstraction that manages a set of identical pods. It’s ideal for stateless applications where individual pods are interchangeable. Deployments provide features like rolling updates, rollback, and scaling, making them suitable for web servers, APIs, and microservices.</p>
</blockquote>
</li>
<li><p>配置如下</p>
<ul>
<li><strong>replicas: 3</strong>：指定了部署的 Pod 副本数量为 3</li>
<li><strong>selector</strong>:  定义了用于选择哪些 Pod 属于这个 Deployment 的标签选择器</li>
<li><strong>template labels: app: my-webapp</strong>：为新创建的 Pod 添加了标签，用于匹配选择器</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">envFrom:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">database-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">WEBAPP_ENV:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIz</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">database-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Mi</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>apiVersion: apps&#x2F;v1 和 apiVersion: v1 区别</p>
<ul>
<li><strong>apiVersion: apps&#x2F;v1</strong>：<ul>
<li><code>apps/v1</code> 是 Kubernetes 中用于管理应用程序工作负载的 API 版本。</li>
<li>在 <code>apps/v1</code> 版本中，包含了 <code>Deployment</code>、<code>DaemonSet</code>、<code>StatefulSet</code> 等控制器对象的定义。</li>
<li>通常用于创建部署、守护进程集、有状态集等应用程序控制器</li>
</ul>
</li>
<li><strong>apiVersion: v1</strong>：<ul>
<li><code>v1</code> 是 Kubernetes 中核心 API 对象的稳定版本。</li>
<li>在 <code>v1</code> 版本中，包含了核心对象如 <code>Pod</code>、<code>Service</code>、<code>Namespace</code>、<code>ConfigMap</code>、<code>Secret</code> 等的定义。</li>
<li>用于创建核心资源对象，如 Pod、Service、ConfigMap 等</li>
</ul>
</li>
</ul>
</li>
<li><p>此时删除 pod，deployment 会自动再次生成 pod</p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240728153759439.png" alt="image-20240728153759439"></p>
</li>
<li><p>如果需要彻底删除</p>
<ol>
<li>使用 <code>kubectl get deployments</code> 拿到 <code>&lt;deployment-name&gt;</code></li>
<li>彻底删除 <code>kubectl delete deployment &lt;deployment-name&gt;</code>，将触发 Kubernetes 控制器删除该 Deployment 中的所有 Pod，删除有时间间隔，可以通过 <code>kubectl get events</code> 查看</li>
</ol>
</li>
</ul>
<h2 id="版本8——StatefulSet"><a href="#版本8——StatefulSet" class="headerlink" title="版本8——StatefulSet"></a>版本8——StatefulSet</h2><ul>
<li><p>既然无状态应用有 deployment，那么像 DB 这样的有状态应用，也有对应的处理方式</p>
</li>
<li><p>k8s 提供了 <code>StatefulSet</code> 的概念，<strong>用于有状态应用的生命周期管理</strong></p>
<blockquote>
<p>On the other hand, a Kubernetes <code>StatefulSet</code> is used for stateful applications where each pod has a unique identity and persistent storage. StatefulSets provide stable network identities and are suitable for databases, key-value stores, and other applications that require unique persistent storage and ordered scaling.</p>
</blockquote>
</li>
<li><p>配置如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:v1.27.0</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">envFrom:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">database-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">database</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">database</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mysql:v9.0.1</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">database-pvc</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">database-data</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">10Mi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">WEBAPP_ENV:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIz</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">database-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Mi</span></span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240728162254921.png" alt="image-20240728162254921"></p>
</li>
</ul>
<h1 id="k8s-error"><a href="#k8s-error" class="headerlink" title="k8s error"></a>k8s error</h1><h2 id="pod-报错-ErrImagePull-或-ImagePullBackOff"><a href="#pod-报错-ErrImagePull-或-ImagePullBackOff" class="headerlink" title="pod 报错 ErrImagePull 或 ImagePullBackOff"></a>pod 报错 ErrImagePull 或 ImagePullBackOff</h2><ul>
<li><p>通过 <code>kubectl describe pods [pod name]</code> 可查看详细信息，从 Events 可看到报错信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning  Failed     11m                   kubelet            Failed to pull image &quot;nginx:latest&quot;: failed to pull and unpack image &quot;docker.io/library/nginx:latest&quot;: failed to copy: httpReadSeeker: failed open: failed to do request: Get &quot;https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/a7/a72860cb95fd59e9c696c66441c64f18e66915fa26b249911e83c3854477ed9a/data?verify=1722076145-hCjnrHPwpwV1nad%2F30IHJ5M0EIE%3D&quot;: dial tcp 173.231.12.107:443: connect: connection refused</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到 k8s 无法拉取镜像，是因为 kind 需要将 image 加载到 cluster 中（否则会去官网 pull 镜像），并且 kind 不建议使用 latest，因此使用指定 tag 加载进 cluster，可见 <a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/known-issues/#unable-to-pull-images">Unable to pull images</a></p>
<blockquote>
<p><strong>NOTE</strong>: The Kubernetes default pull policy is <code>IfNotPresent</code> unless the image tag is <code>:latest</code> or omitted (and implicitly <code>:latest</code>) in which case the default policy is <code>Always</code>. <code>IfNotPresent</code> causes the Kubelet to skip pulling an image if it already exists. If you want those images loaded into node to work as expected, please:</p>
<ul>
<li>don’t use a <code>:latest</code> tag</li>
</ul>
<p>and &#x2F; or:</p>
<ul>
<li>specify <code>imagePullPolicy: IfNotPresent</code> or <code>imagePullPolicy: Never</code> on your container(s).</li>
</ul>
<p>See <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/images/#updating-images">Kubernetes imagePullPolicy</a> for more information.</p>
</blockquote>
</li>
<li><p>将镜像加载到 cluster: <code>kind load docker-image nginx:v1.27.0 mongo:v7.0.12 --name example1</code></p>
</li>
<li><p>查看指定 node 已有的 image: <code>docker exec -it my-node-name crictl images</code></p>
<blockquote>
<p>Where <code>my-node-name</code> is the name of the Docker container (e.g. <code>kind-control-plane</code>).</p>
</blockquote>
</li>
</ul>
<h1 id="k8s-常用操作"><a href="#k8s-常用操作" class="headerlink" title="k8s 常用操作"></a>k8s 常用操作</h1><ul>
<li>查看特定 node 上的 pod: <code>kubectl get pods --field-selector spec.nodeName=&lt;node-name&gt;</code></li>
</ul>
<h1 id="附-centos-安装错误"><a href="#附-centos-安装错误" class="headerlink" title="附 centos 安装错误"></a>附 centos 安装错误</h1><ol>
<li><p>kind create cluster 运行报错: <code>docker: Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: cgroup namespaces aren&#39;t enabled in the kernel: unknown.</code></p>
<p><img src="/cloud/k8s-02-quickly-start/image-20240721155039042.png" alt="image-20240721155039042"></p>
<ul>
<li><p>尝试解决，无果，相关问题 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kind/issues/3311">kind: v0.20.0 cannot create clusters on RHEL 7</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 检查内核配置, 如果输出中显示CONFIG_CGROUPS=n，则表示cgroup未启用</span></span><br><span class="line">sudo cat /boot/config-$(uname -r) | grep CONFIG_CGROUPS</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 修改参数</span></span><br><span class="line">sudo vi /etc/default/grub</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果存在 在最后附加</span></span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 生效</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看引导方式</span></span><br><span class="line">grub-install --version</span><br><span class="line">grub2-install --version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于GRUB引导</span></span><br><span class="line">sudo update-grub</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于GRUB2引导</span></span><br><span class="line">sudo grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于Systemd-boot引导</span></span><br><span class="line">sudo bootctl update</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 重启系统</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

<p><img src="/cloud/k8s-02-quickly-start/image-20240721155842722.png" alt="image-20240721155842722"></p>
</li>
</ul>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/quick-start/">https://kind.sigs.k8s.io/docs/user/quick-start/</a></li>
<li><a target="_blank" rel="noopener" href="https://praveendandu24.medium.com/kubernetes-tutorial-for-beginners-mastering-the-basics-in-1-hour-332db7b5916b">Kubernetes Tutorial for Beginners: Mastering the Basics in 1 Hour</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uF411Q7hD/">Bilibili: kubernetes（k8s）教程</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.theodo.com/en/blog/minikube-kubeadm-kind-k3s">Kubernetes technologies: Kubeadm vs MiniKube, Kind and K3S</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">cv-programmer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://bh.ecel.top/cloud/k8s-02-quickly-start/">http://bh.ecel.top/cloud/k8s-02-quickly-start/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://bh.ecel.top" target="_blank">cv-programmer</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post_share"><div class="social-share" data-image="/image/k8s.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/troubleshoot/vmware/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/image/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【TroubleShooting】Vmware 相关</div></div></a></div><div class="next-post pull-right"><a href="/codeLang/Go-05-goroutine/"><img class="next-cover" src="/image/go.jpeg" onerror="onerror=null;src='/image/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【Go】05-goroutine</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/cloud/k8s-01-Introduction/" title="【k8s】01-概述"><img class="cover" src="/image/k8s.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-05</div><div class="title">【k8s】01-概述</div></div></a></div><div><a href="/cloud/container-and-container-runtime/" title="container——未完成"><img class="cover" src="/image/cncf-color-white-bg-github.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-06</div><div class="title">container——未完成</div></div></a></div><div><a href="/cloud/docker-01-docker-build-secret/" title="【Docker】01-构建时 secret 处理"><img class="cover" src="/image/docker.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-17</div><div class="title">【Docker】01-构建时 secret 处理</div></div></a></div><div><a href="/cloud/harbor-02-log/" title="【Harbor】02-日志"><img class="cover" src="/image/harbor-horizontal-color.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-24</div><div class="title">【Harbor】02-日志</div></div></a></div><div><a href="/cloud/harbor-01-overview/" title="【Harbor】01-概述"><img class="cover" src="/image/harbor-horizontal-color.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-24</div><div class="title">【Harbor】01-概述</div></div></a></div><div><a href="/cloud/harbor-03-core/" title="【Harbor】03-core"><img class="cover" src="/image/harbor-horizontal-color.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-31</div><div class="title">【Harbor】03-core</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/image/avatar.jpg" onerror="this.onerror=null;this.src='/image/friend_404.gif'" alt="avatar"/><div class="author-info__name">cv-programmer</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">120</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cv-programmer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cv-programmer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:usetologin@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">集群搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web-db"><span class="toc-number">2.</span> <span class="toc-text">web-db</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC1%E2%80%94%E2%80%94Pod"><span class="toc-number">2.1.</span> <span class="toc-text">版本1——Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC2%E2%80%94%E2%80%94Service%EF%BC%88%E9%9B%86%E7%BE%A4%E5%86%85%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">版本2——Service（集群内服务提供）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC3%E2%80%94%E2%80%94Service%EF%BC%88%E9%9B%86%E7%BE%A4%E5%A4%96%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">版本3——Service（集群外服务提供）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nodeport"><span class="toc-number">2.3.1.</span> <span class="toc-text">nodeport</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress"><span class="toc-number">2.3.2.</span> <span class="toc-text">ingress</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC4%E2%80%94%E2%80%94ConfigMap"><span class="toc-number">2.4.</span> <span class="toc-text">版本4——ConfigMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC5%E2%80%94%E2%80%94Secret"><span class="toc-number">2.5.</span> <span class="toc-text">版本5——Secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC6%E2%80%94%E2%80%94Volume"><span class="toc-number">2.6.</span> <span class="toc-text">版本6——Volume</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC7%E2%80%94%E2%80%94deployment"><span class="toc-number">2.7.</span> <span class="toc-text">版本7——deployment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC8%E2%80%94%E2%80%94StatefulSet"><span class="toc-number">2.8.</span> <span class="toc-text">版本8——StatefulSet</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-error"><span class="toc-number">3.</span> <span class="toc-text">k8s error</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pod-%E6%8A%A5%E9%94%99-ErrImagePull-%E6%88%96-ImagePullBackOff"><span class="toc-number">3.1.</span> <span class="toc-text">pod 报错 ErrImagePull 或 ImagePullBackOff</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">k8s 常用操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84-centos-%E5%AE%89%E8%A3%85%E9%94%99%E8%AF%AF"><span class="toc-number">5.</span> <span class="toc-text">附 centos 安装错误</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve"><img src="/image/go.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Go】07-调试工具 delve"/></a><div class="content"><a class="title" href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve">【Go】07-调试工具 delve</a><time datetime="2025-03-01T14:41:51.000Z" title="发表于 2025-03-01 22:41:51">2025-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cloud/distribution-02-pull-cache/" title="【Distribution】02-mirror"><img src="/image/distribution-logo.svg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Distribution】02-mirror"/></a><div class="content"><a class="title" href="/cloud/distribution-02-pull-cache/" title="【Distribution】02-mirror">【Distribution】02-mirror</a><time datetime="2025-01-11T15:38:39.000Z" title="发表于 2025-01-11 23:38:39">2025-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/codeLang/Go-06-cobra/" title="【Go】06-Cobra"><img src="/image/go.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Go】06-Cobra"/></a><div class="content"><a class="title" href="/codeLang/Go-06-cobra/" title="【Go】06-Cobra">【Go】06-Cobra</a><time datetime="2025-01-11T13:55:29.000Z" title="发表于 2025-01-11 21:55:29">2025-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cloud/distribution-01-overview/" title="【Distribution】01-概述"><img src="/image/distribution-logo.svg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Distribution】01-概述"/></a><div class="content"><a class="title" href="/cloud/distribution-01-overview/" title="【Distribution】01-概述">【Distribution】01-概述</a><time datetime="2025-01-11T10:50:48.000Z" title="发表于 2025-01-11 18:50:48">2025-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/web3/what-is-blockchain/" title="区块链简易 demo"><img src="/image/blockchain.jpg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="区块链简易 demo"/></a><div class="content"><a class="title" href="/web3/what-is-blockchain/" title="区块链简易 demo">区块链简易 demo</a><time datetime="2024-12-14T12:39:20.000Z" title="发表于 2024-12-14 20:39:20">2024-12-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/image/k8s.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By cv-programmer</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>