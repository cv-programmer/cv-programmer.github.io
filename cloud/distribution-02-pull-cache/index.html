<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>【Distribution】02-mirror | cv-programmer</title><meta name="keywords" content="distribution,registry,mirror"><meta name="author" content="cv-programmer"><meta name="copyright" content="cv-programmer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文主要解决以下问题，以当前 release 最新版 v2.8.3 源码进行分析（最新 tag 为 v3.0.0-rc.2）   distribution 作为 mirror （即pull cache） 的实现原理是什么？首次时数据怎么落盘，第二次本地有数据了，如何返回给客户端？  storage 中 cache 中存的内容是什么？如何加快速度  如何查看 docker pull 时真正的请求地址">
<meta property="og:type" content="article">
<meta property="og:title" content="【Distribution】02-mirror">
<meta property="og:url" content="http://bh.ecel.top/cloud/distribution-02-pull-cache/index.html">
<meta property="og:site_name" content="cv-programmer">
<meta property="og:description" content="本文主要解决以下问题，以当前 release 最新版 v2.8.3 源码进行分析（最新 tag 为 v3.0.0-rc.2）   distribution 作为 mirror （即pull cache） 的实现原理是什么？首次时数据怎么落盘，第二次本地有数据了，如何返回给客户端？  storage 中 cache 中存的内容是什么？如何加快速度  如何查看 docker pull 时真正的请求地址">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://bh.ecel.top/image/distribution-logo.svg">
<meta property="article:published_time" content="2025-01-11T15:38:39.000Z">
<meta property="article:modified_time" content="2025-03-16T08:02:40.759Z">
<meta property="article:author" content="cv-programmer">
<meta property="article:tag" content="distribution">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="mirror">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://bh.ecel.top/image/distribution-logo.svg"><link rel="shortcut icon" href="/image/avatar.jpg"><link rel="canonical" href="http://bh.ecel.top/cloud/distribution-02-pull-cache/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":10,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-16 16:02:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/image/avatar.jpg" onerror="onerror=null;src='/image/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">126</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/distribution-logo.svg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">cv-programmer</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【Distribution】02-mirror</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-11T15:38:39.000Z" title="发表于 2025-01-11 23:38:39">2025-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-16T08:02:40.759Z" title="更新于 2025-03-16 16:02:40">2025-03-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本文主要解决以下问题，以当前 release 最新版 <a target="_blank" rel="noopener" href="https://github.com/distribution/distribution/releases/tag/v2.8.3">v2.8.3</a> 源码进行分析（最新 tag 为 v3.0.0-rc.2）</p>
<ul>
<li><input checked disabled type="checkbox"> distribution 作为 mirror （即pull cache） 的实现原理是什么？首次时数据怎么落盘，第二次本地有数据了，如何返回给客户端？</li>
<li><input checked disabled type="checkbox"> storage 中 cache 中存的内容是什么？如何加快速度</li>
<li><input checked disabled type="checkbox"> 如何查看 docker pull 时真正的请求地址</li>
</ul>
<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><ul>
<li><p>对于问题一</p>
<ul>
<li>当接收到 client 请求时，以 <code>blob</code> 为例，经过一系列调用，会调用 <code>GetBlob</code> ，如果是首次，则会回源 <code>proxy</code> 并将数据在写入磁盘后，再返回给 client，如果是非首次，那么直接从磁盘返回数据。如果配置了 <code>cache</code>，那么每次执行前，都会尝试访问 <code>cache</code> 以加快索引</li>
</ul>
</li>
<li><p>对于问题二</p>
<ul>
<li><p>本例中测试的 blob 会存入以下数据</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;repository::library/alpine::blobs::sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;</span><br><span class="line">2) &quot;repository::library/alpine::blobs&quot;</span><br><span class="line">3) &quot;blobs::sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;</span><br><span class="line">127.0.0.1:6379&gt; HGETALL &quot;repository::library/alpine::blobs::sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;</span><br><span class="line">1) &quot;mediatype&quot;</span><br><span class="line">2) &quot;application/octet-stream&quot;</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS &quot;repository::library/alpine::blobs&quot;</span><br><span class="line">1) &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;</span><br><span class="line">127.0.0.1:6379&gt; HGETALL &quot;blobs::sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;</span><br><span class="line">1) &quot;size&quot;</span><br><span class="line">2) &quot;3418409&quot;</span><br><span class="line">3) &quot;mediatype&quot;</span><br><span class="line">4) &quot;application/octet-stream&quot;</span><br><span class="line">5) &quot;digest&quot;</span><br><span class="line">6) &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>
</li>
<li><p>因为对于请求 url，如果是首次，那么就会经过一系列计算逻辑，得到这些值，因此存入 redis 后，可快速构建 HTTP 响应返回 client，加快速度</p>
</li>
</ul>
</li>
<li><p>对于问题三</p>
<ul>
<li>registry 启动后，可在 <code>proxy.log</code> 查看请求日志</li>
</ul>
</li>
</ul>
<h1 id="在开始之前"><a href="#在开始之前" class="headerlink" title="在开始之前"></a>在开始之前</h1><p><a target="_blank" rel="noopener" href="https://distribution.github.io/distribution/recipes/mirror/">官方文档</a> 中关于 mirror 的运作原理如下，可以看到 mirror 在首次被请求时，会回源数据并缓存到本地存储，后续请求则会直接从 mirror 本地返回</p>
<blockquote>
<h2 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work?"></a>How does it work?</h2><p>The first time you request an image from your local registry mirror, it pulls the image from the public Docker registry and stores it locally before handing it back to you. On subsequent requests, the local registry mirror is able to serve the image from its own storage.</p>
<h3 id="What-if-the-content-changes-on-the-Hub"><a href="#What-if-the-content-changes-on-the-Hub" class="headerlink" title="What if the content changes on the Hub?"></a>What if the content changes on the Hub?</h3><p>When a pull is attempted with a tag, the Registry checks the remote to ensure if it has the latest version of the requested content. Otherwise, it fetches and caches the latest content.</p>
<h3 id="What-about-my-disk"><a href="#What-about-my-disk" class="headerlink" title="What about my disk?"></a>What about my disk?</h3><p>In environments with high churn rates, stale data can build up in the cache. When running as a pull through cache the Registry periodically removes old content to save disk space. Subsequent requests for removed content causes a remote fetch and local re-caching.</p>
<p>To ensure best performance and guarantee correctness the Registry cache should be configured to use the <code>filesystem</code> driver for storage.</p>
</blockquote>
<p>配置上，则是需要在配置文件中加下如下内容，才可作为 mirror 使用</p>
<blockquote>
<p>The easiest way to run a registry as a pull through cache is to run the official Registry image. At least, you need to specify <code>proxy.remoteurl</code> within <code>/etc/distribution/config.yml</code> as described in the following subsection.</p>
<p>Multiple registry caches can be deployed over the same back-end. A single registry cache ensures that concurrent requests do not pull duplicate data, but this property does not hold true for a registry cache cluster.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy:</span></span><br><span class="line">  <span class="attr">remoteurl:</span> <span class="string">https://registry-1.docker.io</span></span><br><span class="line">  <span class="attr">username:</span> [<span class="string">username</span>]</span><br><span class="line">  <span class="attr">password:</span> [<span class="string">password</span>]</span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">168h</span></span><br></pre></td></tr></table></figure>

<p>但 pull 请求的服务入口是什么？请求的流转路径是什么，这些都没有详细的解释，下面将通过源码剖析的方式进行分析。其中一些基础的概念已在 <a href="/cloud/distribution-01-overview/" title="【Distribution】01-概述">【Distribution】01-概述</a> 中，此处不再赘述。</p>
<h1 id="镜像-pull"><a href="#镜像-pull" class="headerlink" title="镜像 pull"></a>镜像 pull</h1><p>从 <a target="_blank" rel="noopener" href="https://huweicai.com/harbor-pull-principle/">镜像仓库Harbor Pull实现原理</a> 了解到，对于 distribution, 镜像 pull 会依次调用以下接口</p>
<ul>
<li><code>/v2/*/manifests/*</code></li>
<li><code>/v2/*/blobs/*</code></li>
</ul>
<p>相应的接口文档可在 <a target="_blank" rel="noopener" href="https://github.com/distribution/distribution/blob/v2.8.3/docs/spec/api.md">docs&#x2F;spec&#x2F;api.md</a> 找到，后面将根据调用链进行源码分析。</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>在此之前，作为 mirror 使用的 distribution，有一些初始化动作，需要了解清楚，源码如下</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/app.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewApp</span><span class="params">(ctx context.Context, config *configuration.Configuration)</span></span> *App &#123;</span><br><span class="line">    app := &amp;App&#123;</span><br><span class="line">		Config:  config,</span><br><span class="line">		Context: ctx,</span><br><span class="line">		router:  v2.RouterWithPrefix(config.HTTP.Prefix),</span><br><span class="line">		isCache: config.Proxy.RemoteURL != <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// configure as a pull through cache</span></span><br><span class="line">	<span class="keyword">if</span> config.Proxy.RemoteURL != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		app.registry, err = proxy.NewRegistryPullThroughCache(ctx, app.registry, app.driver, config.Proxy)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		app.isCache = <span class="literal">true</span></span><br><span class="line">		dcontext.GetLogger(app).Info(<span class="string">&quot;Registry configured as a proxy cache to &quot;</span>, config.Proxy.RemoteURL)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，调用了 <code>NewRegistryPullThroughCache</code> 初始化 mirror 的一些行为，源码如下，主要工作是</p>
<ul>
<li>初始化了 <code>scheduler-state.json</code>，用于存放 <code>blob</code> 和 <code>manifest</code> 的过期行为</li>
</ul>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/proxy/proxyregistry.go</span></span><br><span class="line"><span class="comment">// NewRegistryPullThroughCache creates a registry acting as a pull through cache</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRegistryPullThroughCache</span><span class="params">(ctx context.Context, registry distribution.Namespace, driver driver.StorageDriver, config configuration.Proxy)</span></span> (distribution.Namespace, <span class="type">error</span>) &#123;</span><br><span class="line">	remoteURL, err := url.Parse(config.RemoteURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v := storage.NewVacuum(ctx, driver)</span><br><span class="line">	s := scheduler.New(ctx, driver, <span class="string">&quot;/scheduler-state.json&quot;</span>)</span><br><span class="line">	s.OnBlobExpire(<span class="function"><span class="keyword">func</span><span class="params">(ref reference.Reference)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="comment">// reference.Canonical 是一个接口，定义可见 https://github.com/distribution/reference/blob/main/reference.go#L175</span></span><br><span class="line">		<span class="comment">// Canonical reference is an object with a fully unique</span></span><br><span class="line">		<span class="comment">// name including a name with domain and digest</span></span><br><span class="line">		<span class="comment">// type Canonical interface &#123;</span></span><br><span class="line">		<span class="comment">// 	Named</span></span><br><span class="line">		<span class="comment">// 	Digest() digest.Digest</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="keyword">var</span> r reference.Canonical</span><br><span class="line">		<span class="keyword">var</span> ok <span class="type">bool</span></span><br><span class="line">		<span class="keyword">if</span> r, ok = ref.(reference.Canonical); !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unexpected reference type : %T&quot;</span>, ref)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		repo, err := registry.Repository(ctx, r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		blobs := repo.Blobs(ctx)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Clear the repository reference and descriptor caches</span></span><br><span class="line">		err = blobs.Delete(ctx, r.Digest())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = v.RemoveBlob(r.Digest().String())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	s.OnManifestExpire(<span class="function"><span class="keyword">func</span><span class="params">(ref reference.Reference)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> r reference.Canonical</span><br><span class="line">		<span class="keyword">var</span> ok <span class="type">bool</span></span><br><span class="line">		<span class="keyword">if</span> r, ok = ref.(reference.Canonical); !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unexpected reference type : %T&quot;</span>, ref)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		repo, err := registry.Repository(ctx, r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		manifests, err := repo.Manifests(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		err = manifests.Delete(ctx, r.Digest())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	err = s.Start()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cs, err := configureAuth(config.Username, config.Password, config.RemoteURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;proxyingRegistry&#123;</span><br><span class="line">		embedded:  registry,</span><br><span class="line">		scheduler: s,</span><br><span class="line">		remoteURL: *remoteURL,</span><br><span class="line">		authChallenger: &amp;remoteAuthChallenger&#123;</span><br><span class="line">			remoteURL: *remoteURL,</span><br><span class="line">			cm:        challenge.NewSimpleManager(),</span><br><span class="line">			cs:        cs,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求链路"><a href="#请求链路" class="headerlink" title="请求链路"></a>请求链路</h2><p>在 <a href="/cloud/distribution-01-overview/" title="【Distribution】01-概述">【Distribution】01-概述</a> 中已经提到</p>
<blockquote>
<p>其中 <code>NewApp</code> 用于真正处理请求，分为以下几个步骤</p>
<ol>
<li>注册分发器，用于处理不同的请求，分发器的实际处理代码位于 <code>registry/api/v2/descriptors.go</code> 中，对应的 handler 位于 <code>registry/handlers/&#123;handler&#125;.go</code> 中</li>
<li>通过配置文件配置相应的组件</li>
</ol>
</blockquote>
<p>从 <code>app.go</code> 可以看到，针对 blob 获取注册相应的处理函数如下</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/app.go</span></span><br><span class="line">app.register(v2.RouteNameBlob, blobDispatcher)</span><br></pre></td></tr></table></figure>

<p>首先是在 <code>routeDescriptors</code> 中定义了相关的行为，针对 pull 场景，就是 <code>RouteNameBlob</code>，大体分为 <code>GET</code> 和 <code>DELETE</code> 两个操作，其中 <code>GET</code> 又分为 <code>Fetch Blob</code> 和 <code>Fetch Blob Part</code> ，根据描述可以知道，两者的使用场景来源于客户端的请求方式，因此一般情况下，会走到 <code>Fetch Blob</code> 的逻辑，后面也会以这个进行分析</p>
<blockquote>
<p>Name:     “Fetch Blob Part”,</p>
<p>Description: “This endpoint may also support RFC7233 compliant range requests. Support can be detected by issuing a HEAD request. If the header <code>Accept-Range: bytes</code> is returned, range requests can be used to fetch partial content.”,</p>
</blockquote>
<p>相关源码如下</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">// registry/api/v2/descriptors.go</span><br><span class="line">var routeDescriptors = []RouteDescriptor&#123;</span><br><span class="line">// ...</span><br><span class="line">&#123;</span><br><span class="line">   Name:        RouteNameBlob,</span><br><span class="line">   Path:        &quot;/v2/&#123;name:&quot; + reference.NameRegexp.String() + &quot;&#125;/blobs/&#123;digest:&quot; + digest.DigestRegexp.String() + &quot;&#125;&quot;,</span><br><span class="line">   Entity:      &quot;Blob&quot;,</span><br><span class="line">   Description: &quot;Operations on blobs identified by `name` and `digest`. Used to fetch or delete layers by digest.&quot;,</span><br><span class="line">   Methods: []MethodDescriptor&#123;</span><br><span class="line">	   &#123;</span><br><span class="line">		   Method:      &quot;GET&quot;,</span><br><span class="line">		   Description: &quot;Retrieve the blob from the registry identified by `digest`. A `HEAD` request can also be issued to this endpoint to obtain resource information without receiving all data.&quot;,</span><br><span class="line">		   Requests: []RequestDescriptor&#123;</span><br><span class="line">			   &#123;</span><br><span class="line">				   Name: &quot;Fetch Blob&quot;,</span><br><span class="line">				   Headers: []ParameterDescriptor&#123;</span><br><span class="line">					   hostHeader,</span><br><span class="line">					   authHeader,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   PathParameters: []ParameterDescriptor&#123;</span><br><span class="line">					   nameParameterDescriptor,</span><br><span class="line">					   digestPathParameter,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   Successes: []ResponseDescriptor&#123;</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;The blob identified by `digest` is available. The blob content will be present in the body of the request.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusOK,</span><br><span class="line">						   Headers: []ParameterDescriptor&#123;</span><br><span class="line">							   &#123;</span><br><span class="line">								   Name:        &quot;Content-Length&quot;,</span><br><span class="line">								   Type:        &quot;integer&quot;,</span><br><span class="line">								   Description: &quot;The length of the requested blob content.&quot;,</span><br><span class="line">								   Format:      &quot;&lt;length&gt;&quot;,</span><br><span class="line">							   &#125;,</span><br><span class="line">							   digestHeader,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/octet-stream&quot;,</span><br><span class="line">							   Format:      &quot;&lt;blob binary data&gt;&quot;,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;The blob identified by `digest` is available at the provided location.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusTemporaryRedirect,</span><br><span class="line">						   Headers: []ParameterDescriptor&#123;</span><br><span class="line">							   &#123;</span><br><span class="line">								   Name:        &quot;Location&quot;,</span><br><span class="line">								   Type:        &quot;url&quot;,</span><br><span class="line">								   Description: &quot;The location where the layer should be accessible.&quot;,</span><br><span class="line">								   Format:      &quot;&lt;blob location&gt;&quot;,</span><br><span class="line">							   &#125;,</span><br><span class="line">							   digestHeader,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   Failures: []ResponseDescriptor&#123;</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;There was a problem with the request that needs to be addressed by the client, such as an invalid `name` or `tag`.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusBadRequest,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   ErrorCodeNameInvalid,</span><br><span class="line">							   ErrorCodeDigestInvalid,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">							   Format:      errorsBody,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;The blob, identified by `name` and `digest`, is unknown to the registry.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusNotFound,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">							   Format:      errorsBody,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   ErrorCodeNameUnknown,</span><br><span class="line">							   ErrorCodeBlobUnknown,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   unauthorizedResponseDescriptor,</span><br><span class="line">					   repositoryNotFoundResponseDescriptor,</span><br><span class="line">					   deniedResponseDescriptor,</span><br><span class="line">					   tooManyRequestsDescriptor,</span><br><span class="line">				   &#125;,</span><br><span class="line">			   &#125;,</span><br><span class="line">			   &#123;</span><br><span class="line">				   Name:        &quot;Fetch Blob Part&quot;,</span><br><span class="line">				   Description: &quot;This endpoint may also support RFC7233 compliant range requests. Support can be detected by issuing a HEAD request. If the header `Accept-Range: bytes` is returned, range requests can be used to fetch partial content.&quot;,</span><br><span class="line">				   Headers: []ParameterDescriptor&#123;</span><br><span class="line">					   hostHeader,</span><br><span class="line">					   authHeader,</span><br><span class="line">					   &#123;</span><br><span class="line">						   Name:        &quot;Range&quot;,</span><br><span class="line">						   Type:        &quot;string&quot;,</span><br><span class="line">						   Description: &quot;HTTP Range header specifying blob chunk.&quot;,</span><br><span class="line">						   Format:      &quot;bytes=&lt;start&gt;-&lt;end&gt;&quot;,</span><br><span class="line">					   &#125;,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   PathParameters: []ParameterDescriptor&#123;</span><br><span class="line">					   nameParameterDescriptor,</span><br><span class="line">					   digestPathParameter,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   Successes: []ResponseDescriptor&#123;</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;The blob identified by `digest` is available. The specified chunk of blob content will be present in the body of the request.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusPartialContent,</span><br><span class="line">						   Headers: []ParameterDescriptor&#123;</span><br><span class="line">							   &#123;</span><br><span class="line">								   Name:        &quot;Content-Length&quot;,</span><br><span class="line">								   Type:        &quot;integer&quot;,</span><br><span class="line">								   Description: &quot;The length of the requested blob chunk.&quot;,</span><br><span class="line">								   Format:      &quot;&lt;length&gt;&quot;,</span><br><span class="line">							   &#125;,</span><br><span class="line">							   &#123;</span><br><span class="line">								   Name:        &quot;Content-Range&quot;,</span><br><span class="line">								   Type:        &quot;byte range&quot;,</span><br><span class="line">								   Description: &quot;Content range of blob chunk.&quot;,</span><br><span class="line">								   Format:      &quot;bytes &lt;start&gt;-&lt;end&gt;/&lt;size&gt;&quot;,</span><br><span class="line">							   &#125;,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/octet-stream&quot;,</span><br><span class="line">							   Format:      &quot;&lt;blob binary data&gt;&quot;,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   Failures: []ResponseDescriptor&#123;</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;There was a problem with the request that needs to be addressed by the client, such as an invalid `name` or `tag`.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusBadRequest,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   ErrorCodeNameInvalid,</span><br><span class="line">							   ErrorCodeDigestInvalid,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">							   Format:      errorsBody,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   &#123;</span><br><span class="line">						   StatusCode: http.StatusNotFound,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   ErrorCodeNameUnknown,</span><br><span class="line">							   ErrorCodeBlobUnknown,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">							   Format:      errorsBody,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;The range specification cannot be satisfied for the requested content. This can happen when the range is not formatted correctly or if the range is outside of the valid size of the content.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusRequestedRangeNotSatisfiable,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   unauthorizedResponseDescriptor,</span><br><span class="line">					   repositoryNotFoundResponseDescriptor,</span><br><span class="line">					   deniedResponseDescriptor,</span><br><span class="line">					   tooManyRequestsDescriptor,</span><br><span class="line">				   &#125;,</span><br><span class="line">			   &#125;,</span><br><span class="line">		   &#125;,</span><br><span class="line">	   &#125;,</span><br><span class="line">	   &#123;</span><br><span class="line">		   Method:      &quot;DELETE&quot;,</span><br><span class="line">		   Description: &quot;Delete the blob identified by `name` and `digest`&quot;,</span><br><span class="line">		   Requests: []RequestDescriptor&#123;</span><br><span class="line">			   &#123;</span><br><span class="line">				   Headers: []ParameterDescriptor&#123;</span><br><span class="line">					   hostHeader,</span><br><span class="line">					   authHeader,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   PathParameters: []ParameterDescriptor&#123;</span><br><span class="line">					   nameParameterDescriptor,</span><br><span class="line">					   digestPathParameter,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   Successes: []ResponseDescriptor&#123;</span><br><span class="line">					   &#123;</span><br><span class="line">						   StatusCode: http.StatusAccepted,</span><br><span class="line">						   Headers: []ParameterDescriptor&#123;</span><br><span class="line">							   &#123;</span><br><span class="line">								   Name:        &quot;Content-Length&quot;,</span><br><span class="line">								   Type:        &quot;integer&quot;,</span><br><span class="line">								   Description: &quot;0&quot;,</span><br><span class="line">								   Format:      &quot;0&quot;,</span><br><span class="line">							   &#125;,</span><br><span class="line">							   digestHeader,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">				   &#125;,</span><br><span class="line">				   Failures: []ResponseDescriptor&#123;</span><br><span class="line">					   &#123;</span><br><span class="line">						   Name:       &quot;Invalid Name or Digest&quot;,</span><br><span class="line">						   StatusCode: http.StatusBadRequest,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   ErrorCodeDigestInvalid,</span><br><span class="line">							   ErrorCodeNameInvalid,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;The blob, identified by `name` and `digest`, is unknown to the registry.&quot;,</span><br><span class="line">						   StatusCode:  http.StatusNotFound,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">							   Format:      errorsBody,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   ErrorCodeNameUnknown,</span><br><span class="line">							   ErrorCodeBlobUnknown,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   &#123;</span><br><span class="line">						   Description: &quot;Blob delete is not allowed because the registry is configured as a pull-through cache or `delete` has been disabled&quot;,</span><br><span class="line">						   StatusCode:  http.StatusMethodNotAllowed,</span><br><span class="line">						   Body: BodyDescriptor&#123;</span><br><span class="line">							   ContentType: &quot;application/json; charset=utf-8&quot;,</span><br><span class="line">							   Format:      errorsBody,</span><br><span class="line">						   &#125;,</span><br><span class="line">						   ErrorCodes: []errcode.ErrorCode&#123;</span><br><span class="line">							   errcode.ErrorCodeUnsupported,</span><br><span class="line">						   &#125;,</span><br><span class="line">					   &#125;,</span><br><span class="line">					   unauthorizedResponseDescriptor,</span><br><span class="line">					   repositoryNotFoundResponseDescriptor,</span><br><span class="line">					   deniedResponseDescriptor,</span><br><span class="line">					   tooManyRequestsDescriptor,</span><br><span class="line">				   &#125;,</span><br><span class="line">			   &#125;,</span><br><span class="line">		   &#125;,</span><br><span class="line">	   &#125;,</span><br><span class="line">	   // TODO(stevvooe): We may want to add a PUT request here to</span><br><span class="line">	   // kickoff an upload of a blob, integrated with the blob upload</span><br><span class="line">	   // API.</span><br><span class="line">   &#125;,</span><br><span class="line">&#125;,</span><br><span class="line">// ...</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>再看 <code>blobDispatcher</code> 代码如下</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/blob.go</span></span><br><span class="line"><span class="comment">// blobDispatcher uses the request context to build a blobHandler.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">blobDispatcher</span><span class="params">(ctx *Context, r *http.Request)</span></span> http.Handler &#123;</span><br><span class="line">	dgst, err := getDigest(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err == errDigestNotAvailable &#123;</span><br><span class="line">			<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">				ctx.Errors = <span class="built_in">append</span>(ctx.Errors, v2.ErrorCodeDigestInvalid.WithDetail(err))</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">			ctx.Errors = <span class="built_in">append</span>(ctx.Errors, v2.ErrorCodeDigestInvalid.WithDetail(err))</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	blobHandler := &amp;blobHandler&#123;</span><br><span class="line">		Context: ctx,</span><br><span class="line">		Digest:  dgst,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mhandler := handlers.MethodHandler&#123;</span><br><span class="line">		<span class="string">&quot;GET&quot;</span>:  http.HandlerFunc(blobHandler.GetBlob),</span><br><span class="line">		<span class="string">&quot;HEAD&quot;</span>: http.HandlerFunc(blobHandler.GetBlob),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !ctx.readOnly &#123;</span><br><span class="line">		mhandler[<span class="string">&quot;DELETE&quot;</span>] = http.HandlerFunc(blobHandler.DeleteBlob)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mhandler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，其中关键是调用了 <code>GetBlob</code> 函数，如下</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/blob.go</span></span><br><span class="line"><span class="comment">// GetBlob fetches the binary data from backend storage returns it in the</span></span><br><span class="line"><span class="comment">// response.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bh *blobHandler)</span></span> GetBlob(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">	context.GetLogger(bh).Debug(<span class="string">&quot;GetBlob&quot;</span>)</span><br><span class="line">	blobs := bh.Repository.Blobs(bh)</span><br><span class="line">    <span class="comment">// 根据 digest 获取 desc（会先走 cache，如果 miss，则会 set cache），详细可见 delve 调试</span></span><br><span class="line">	desc, err := blobs.Stat(bh, bh.Digest)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err == distribution.ErrBlobUnknown &#123;</span><br><span class="line">			bh.Errors = <span class="built_in">append</span>(bh.Errors, v2.ErrorCodeBlobUnknown.WithDetail(bh.Digest))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			bh.Errors = <span class="built_in">append</span>(bh.Errors, errcode.ErrorCodeUnknown.WithDetail(err))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := blobs.ServeBlob(bh, w, r, desc.Digest); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		context.GetLogger(bh).Debugf(<span class="string">&quot;unexpected error getting blob HTTP handler: %v&quot;</span>, err)</span><br><span class="line">		bh.Errors = <span class="built_in">append</span>(bh.Errors, errcode.ErrorCodeUnknown.WithDetail(err))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>精彩的来了，<code>blobs := bh.Repository.Blobs(bh)</code> 从这里开始用了大量的封装抽象</p>
<ol>
<li><p>首先是 <code>bh</code>，即 <code>blobHandler</code>，定义如下，可以看到是一个嵌套结构体，因此可以直接使用 <code>Context</code> 定义的字段</p>
<blockquote>
<p>在 Go 中，嵌入一个结构体意味着可以在外部结构体中直接访问嵌入的结构体的字段和方法，而不需要显式地使用嵌入结构体的名称</p>
</blockquote>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/blob.go</span></span><br><span class="line"><span class="comment">// blobHandler serves http blob requests.</span></span><br><span class="line"><span class="keyword">type</span> blobHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">	*Context</span><br><span class="line"></span><br><span class="line">	Digest digest.Digest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中 <code>Context</code> 是结构体，内含 <code>Repository</code> 字段</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/context.go</span></span><br><span class="line"><span class="comment">// Context should contain the request specific context for use in across</span></span><br><span class="line"><span class="comment">// handlers. Resources that don&#x27;t need to be shared across handlers should not</span></span><br><span class="line"><span class="comment">// be on this object.</span></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// App points to the application structure that created this context.</span></span><br><span class="line">	*App</span><br><span class="line">	context.Context</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Repository is the repository for the current request. All requests</span></span><br><span class="line">	<span class="comment">// should be scoped to a single repository. This field may be nil.</span></span><br><span class="line">	Repository distribution.Repository</span><br><span class="line"></span><br><span class="line">	<span class="comment">// RepositoryRemover provides method to delete a repository</span></span><br><span class="line">	RepositoryRemover distribution.RepositoryRemover</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Errors is a collection of errors encountered during the request to be</span></span><br><span class="line">	<span class="comment">// returned to the client API. If errors are added to the collection, the</span></span><br><span class="line">	<span class="comment">// handler *must not* start the response via http.ResponseWriter.</span></span><br><span class="line">	Errors errcode.Errors</span><br><span class="line"></span><br><span class="line">	urlBuilder *v2.URLBuilder</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(stevvooe): The goal is too completely factor this context and</span></span><br><span class="line">	<span class="comment">// dispatching out of the web application. Ideally, we should lean on</span></span><br><span class="line">	<span class="comment">// context.Context for injection of these resources.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Repository</code> 则是一个 <code>interface</code>，定义如下</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry.go</span></span><br><span class="line"><span class="comment">// Repository is a named collection of manifests and layers.</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Named returns the name of the repository.</span></span><br><span class="line">	Named() reference.Named</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Manifests returns a reference to this repository&#x27;s manifest service.</span></span><br><span class="line">	<span class="comment">// with the supplied options applied.</span></span><br><span class="line">	Manifests(ctx context.Context, options ...ManifestServiceOption) (ManifestService, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Blobs returns a reference to this repository&#x27;s blob service.</span></span><br><span class="line">	Blobs(ctx context.Context) BlobStore</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(stevvooe): The above BlobStore return can probably be relaxed to</span></span><br><span class="line">	<span class="comment">// be a BlobService for use with clients. This will allow such</span></span><br><span class="line">	<span class="comment">// implementations to avoid implementing ServeBlob.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tags returns a reference to this repositories tag service</span></span><br><span class="line">	Tags(ctx context.Context) TagService</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>到了这一步，能够知道，为了支持不同场景，因此只需要实现 <code>Blobs</code> 方法，即可以用接口调用，此时，全局搜索可以发现，一共有以下几个方法</p>
<ul>
<li><code>notifications/listener.go</code></li>
<li><code>registry/client/repository.go</code></li>
<li><code>registry/proxy/proxyregistry.go</code></li>
<li><code>registry/storage/registry.go</code></li>
</ul>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// notifications/listener.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rl *repositoryListener)</span></span> Blobs(ctx context.Context) distribution.BlobStore &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;blobServiceListener&#123;</span><br><span class="line">		BlobStore: rl.Repository.Blobs(ctx),</span><br><span class="line">		parent:    rl,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// registry/client/repository.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *repository)</span></span> Blobs(ctx context.Context) distribution.BlobStore &#123;</span><br><span class="line">	statter := &amp;blobStatter&#123;</span><br><span class="line">		name:   r.name,</span><br><span class="line">		ub:     r.ub,</span><br><span class="line">		client: r.client,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;blobs&#123;</span><br><span class="line">		name:    r.name,</span><br><span class="line">		ub:      r.ub,</span><br><span class="line">		client:  r.client,</span><br><span class="line">		statter: cache.NewCachedBlobStatter(memory.NewInMemoryBlobDescriptorCacheProvider(), statter),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// registry/proxy/proxyregistry.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pr *proxiedRepository)</span></span> Blobs(ctx context.Context) distribution.BlobStore &#123;</span><br><span class="line">	<span class="keyword">return</span> pr.blobStore</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// registry/storage/registry.go</span></span><br><span class="line"><span class="comment">// Blobs returns an instance of the BlobStore. Instantiation is cheap and</span></span><br><span class="line"><span class="comment">// may be context sensitive in the future. The instance should be used similar</span></span><br><span class="line"><span class="comment">// to a request local.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *repository)</span></span> Blobs(ctx context.Context) distribution.BlobStore &#123;</span><br><span class="line">	<span class="keyword">var</span> statter distribution.BlobDescriptorService = &amp;linkedBlobStatter&#123;</span><br><span class="line">		blobStore:   repo.blobStore,</span><br><span class="line">		repository:  repo,</span><br><span class="line">		linkPathFns: []linkPathFunc&#123;blobLinkPath&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> repo.descriptorCache != <span class="literal">nil</span> &#123;</span><br><span class="line">		statter = cache.NewCachedBlobStatter(repo.descriptorCache, statter)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> repo.registry.blobDescriptorServiceFactory != <span class="literal">nil</span> &#123;</span><br><span class="line">		statter = repo.registry.blobDescriptorServiceFactory.BlobAccessController(statter)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;linkedBlobStore&#123;</span><br><span class="line">		registry:             repo.registry,</span><br><span class="line">		blobStore:            repo.blobStore,</span><br><span class="line">		blobServer:           repo.blobServer,</span><br><span class="line">		blobAccessController: statter,</span><br><span class="line">		repository:           repo,</span><br><span class="line">		ctx:                  ctx,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// TODO(stevvooe): linkPath limits this blob store to only layers.</span></span><br><span class="line">		<span class="comment">// This instance cannot be used for manifest checks.</span></span><br><span class="line">		linkPathFns:            []linkPathFunc&#123;blobLinkPath&#125;,</span><br><span class="line">		deleteEnabled:          repo.registry.deleteEnabled,</span><br><span class="line">		resumableDigestEnabled: repo.resumableDigestEnabled,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管作为 mirror 时，能很明显的知道，实际调用了 <code>registry/proxy/proxyregistry.go</code>，但是需要弄清楚的是</p>
<ol>
<li>为什么 <code>Blobs</code> 方法的实现中，入参是 <code>context.Context</code>，但是实际传入的却是 <code>blobHandler</code></li>
<li>何时进行了定义传入</li>
</ol>
<p>对于第一个问题，是利用了 <code>Golang</code> 中的 <strong>类型嵌套</strong>，即</p>
<blockquote>
<p> 结构体可以嵌套其他结构体。如果一个结构体嵌套了一个接口（如 <code>context.Context</code>），那么它就可以被当作该接口的实现来使用</p>
</blockquote>
<p>因此 <code>blobHandler</code> 嵌套了 <code>*Context</code>,  而 <code>Context</code> 结构体嵌套了 <code>context.Context</code>，因此 <code>*blobHandler</code> 也可以作为 <code>context.Context</code> 类型传递。具体解释可看 <a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2020/embedding-in-go-part-3-interfaces-in-structs">Embedding interfaces in structs</a></p>
<p>对于第二个问题，往回找发现 <a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">初始化</a> 中根据不同条件，对 <code>app.registry</code> 进行了不同的赋值，而对于 <code>mirror</code> 来说，即是如下代码。可以看到，如果设定为 mirror 则优先级最高</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/app.go</span></span><br><span class="line"></span><br><span class="line">app.registry, err = proxy.NewRegistryPullThroughCache(ctx, app.registry, app.driver, config.Proxy)</span><br></pre></td></tr></table></figure>

<p>上面还只是设定了 ctx，真正生效则是在接收请求时，才会真正执行初始化（这个通过 delve 调试能比较好的找到，可以用 <code> b app.go:655</code>），代码如下</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/handlers/app.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *App)</span></span> dispatcher(dispatch dispatchFunc) http.Handler &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    repository, err := app.registry.Repository(context, nameRef)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，当请求到达时，<code>blobDispatcher</code> 能够动态获取到 <code>Repository</code> 的定义为 <code>proxyingRegistry</code> 下的 <code>Repository</code>，后面就是走 <code>proxy</code> 相关逻辑进行处理了</p>
<p>获取到 blobs 后，则调用 <code>desc, err := blobs.Stat(bh, bh.Digest)</code> 获取 <code>blob</code> 相关的信息，主要是获取 <code>digest</code>， <code>size</code> 及 <code>mediatype</code>，<code>desc</code> 具体内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">github.com/docker/distribution.Descriptor &#123;</span><br><span class="line">        MediaType: &quot;application/octet-stream&quot;,</span><br><span class="line">        Size: 3418409,</span><br><span class="line">        Digest: &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdff...+7 more&quot;,</span><br><span class="line">        URLs: []string len: 0, cap: 0, nil,</span><br><span class="line">        Annotations: map[string]string nil,</span><br><span class="line">        Platform: *github.com/docker/distribution/vendor/github.com/opencontainers/image-spec/specs-go/v1.Platform nil,&#125;</span><br></pre></td></tr></table></figure>

<p>这里 <code>Stat</code> 会根据 <code>blobs</code> 的定义 <code>notifications.(*blobServiceListener).Stat()</code> ，并根据 <code>ctx</code> 进入 <code>registry/proxy.(*proxyBlobStore).Stat()</code>，代码如下，可以看到，先尝试本地是否存在，如果不存在则回源</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/proxy/proxyblobstore.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pbs *proxyBlobStore)</span></span> Stat(ctx context.Context, dgst digest.Digest) (distribution.Descriptor, <span class="type">error</span>) &#123;</span><br><span class="line">	desc, err := pbs.localStore.Stat(ctx, dgst)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> desc, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != distribution.ErrBlobUnknown &#123;</span><br><span class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := pbs.authChallenger.tryEstablishChallenges(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> distribution.Descriptor&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pbs.remoteStore.Stat(ctx, dgst)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">这里为什么还得看下</font></p>
<p>本地则先会调用 <code>registry/storage.(*linkedBlobStore).Stat()</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// registry/storage/linkedblobstore.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lbs *linkedBlobStore)</span></span> Stat(ctx context.Context, dgst digest.Digest) (distribution.Descriptor, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> lbs.blobAccessController.Stat(ctx, dgst)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">这里为什么还得看下</font></p>
<p>随即调用 <code>registry/storage/cache.(*cachedBlobStatter).Stat()</code>，这个函数在后续会经常调用（即 cache 处理）</p>
<figure class="highlight go"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cbds *cachedBlobStatter)</span></span> Stat(ctx context.Context, dgst digest.Digest) (distribution.Descriptor, <span class="type">error</span>) &#123;</span><br><span class="line">	cacheCount.WithValues(<span class="string">&quot;Request&quot;</span>).Inc(<span class="number">1</span>)</span><br><span class="line">	desc, err := cbds.cache.Stat(ctx, dgst)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != distribution.ErrBlobUnknown &#123;</span><br><span class="line">			logErrorf(ctx, cbds.tracker, <span class="string">&quot;error retrieving descriptor from cache: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">goto</span> fallback</span><br><span class="line">	&#125;</span><br><span class="line">	cacheCount.WithValues(<span class="string">&quot;Hit&quot;</span>).Inc(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> cbds.tracker != <span class="literal">nil</span> &#123;</span><br><span class="line">		cbds.tracker.Hit()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> desc, <span class="literal">nil</span></span><br><span class="line">fallback:</span><br><span class="line">	cacheCount.WithValues(<span class="string">&quot;Miss&quot;</span>).Inc(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> cbds.tracker != <span class="literal">nil</span> &#123;</span><br><span class="line">		cbds.tracker.Miss()</span><br><span class="line">	&#125;</span><br><span class="line">	desc, err = cbds.backend.Stat(ctx, dgst)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> desc, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := cbds.cache.SetDescriptor(ctx, dgst, desc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logErrorf(ctx, cbds.tracker, <span class="string">&quot;error adding descriptor %v to cache: %v&quot;</span>, desc.Digest, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> desc, err</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="delve-调试"><a href="#delve-调试" class="headerlink" title="delve 调试"></a>delve 调试</h1><p>下面使用 delve 进行 debug，关于 delve 的详细使用，可查看 <a href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve">【Go】07-调试工具 delve</a></p>
<h2 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. debug 启动调试</span></span><br><span class="line">dlv debug cmd/registry/main.go -- serve cmd/registry/config-debug.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 进入后，打断点，如</span></span><br><span class="line">b handlers.GetBlob</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 启动服务</span></span><br><span class="line">c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 模拟请求</span></span><br><span class="line">curl http://localhost:5000/v2/library/alpine/blobs/sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885 -o testfile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. 断点调试</span></span><br><span class="line">s/so/n/c/locals/p blobs</span><br></pre></td></tr></table></figure>

<h2 id="GetBlob-desc-err-blobs-Stat-bh-bh-Digest"><a href="#GetBlob-desc-err-blobs-Stat-bh-bh-Digest" class="headerlink" title="GetBlob desc, err :&#x3D; blobs.Stat(bh, bh.Digest)"></a>GetBlob desc, err :&#x3D; blobs.Stat(bh, bh.Digest)</h2><ul>
<li><p>请求到达后，会根据 <code>ctx</code> 和 <code>dgst</code>首先查看 cache 中是否有相应的文件信息，如果没有，会查询一遍后，信息如下（以下是走到了 cache miss 的逻辑）</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache.(*cachedBlobStatter).Stat() ./registry/storage/cache/cachedblobdescriptorstore.go:87 (PC: 0xb74ff6)</span></span><br><span class="line">    82:         cacheCount.WithValues(&quot;Miss&quot;).Inc(1)</span><br><span class="line">    83:         if cbds.tracker != nil &#123;</span><br><span class="line">    84:                 cbds.tracker.Miss()</span><br><span class="line">    85:         &#125;</span><br><span class="line">    86:         desc, err = cbds.backend.Stat(ctx, dgst)</span><br><span class="line">=&gt;  87:         if err != nil &#123;</span><br><span class="line">    88:                 return desc, err</span><br><span class="line">    89:         &#125;</span><br><span class="line">    90:</span><br><span class="line">    91:         if err := cbds.cache.SetDescriptor(ctx, dgst, desc); err != nil &#123;</span><br><span class="line">    92:                 logErrorf(ctx, cbds.tracker, &quot;error adding descriptor %v to cache: %v&quot;, desc.Digest, err)</span><br><span class="line">(dlv) p desc</span><br><span class="line">github.com/docker/distribution.Descriptor &#123;</span><br><span class="line">        MediaType: &quot;application/octet-stream&quot;,</span><br><span class="line">        Size: 3418409,</span><br><span class="line">        Digest: &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;,</span><br><span class="line">        URLs: []string len: 0, cap: 0, nil,</span><br><span class="line">        Annotations: map[string]string nil,</span><br><span class="line">        Platform: *github.com/docker/distribution/vendor/github.com/opencontainers/image-spec/specs-go/v1.Platform nil,&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果是本地缓存没有，那么就会访问 proxy，并写在本地</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/driver/filesystem.(*driver).GetContent() /root/go/src/github.com/docker/distribution/registry/storage/driver/filesystem/driver.go:119 (PC: 0xd43a96)</span></span><br><span class="line">   114: func (d *driver) Name() string &#123;</span><br><span class="line">   115:         return driverName</span><br><span class="line">   116: &#125;</span><br><span class="line">   117:</span><br><span class="line">   118: // GetContent retrieves the content stored at &quot;path&quot; as a []byte.</span><br><span class="line">=&gt; 119: func (d *driver) GetContent(ctx context.Context, path string) ([]byte, error) &#123;</span><br><span class="line">   120:         rc, err := d.Reader(ctx, path, 0)</span><br><span class="line">   121:         if err != nil &#123;</span><br><span class="line">   122:                 return nil, err</span><br><span class="line">   123:         &#125;</span><br><span class="line">   124:         defer rc.Close()</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/driver/filesystem.(*driver).Reader() /root/go/src/github.com/docker/distribution/registry/storage/driver/filesystem/driver.go:151 (PC: 0xd44456)</span></span><br><span class="line">   146:         return writer.Commit()</span><br><span class="line">   147: &#125;</span><br><span class="line">   148:</span><br><span class="line">   149: // Reader retrieves an io.ReadCloser for the content stored at &quot;path&quot; with a</span><br><span class="line">   150: // given byte offset.</span><br><span class="line">=&gt; 151: func (d *driver) Reader(ctx context.Context, path string, offset int64) (io.ReadCloser, error) &#123;</span><br><span class="line">   152:         file, err := os.OpenFile(d.fullPath(path), os.O_RDONLY, 0644)</span><br><span class="line">   153:         if err != nil &#123;</span><br><span class="line">   154:                 if os.IsNotExist(err) &#123;</span><br><span class="line">   155:                         return nil, storagedriver.PathNotFoundError&#123;Path: path&#125;</span><br><span class="line">   156:                 &#125;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/driver/filesystem.(*driver).Reader() /root/go/src/github.com/docker/distribution/registry/storage/driver/filesystem/driver.go:153 (PC: 0xd44560)</span></span><br><span class="line">   148:</span><br><span class="line">   149: // Reader retrieves an io.ReadCloser for the content stored at &quot;path&quot; with a</span><br><span class="line">   150: // given byte offset.</span><br><span class="line">   151: func (d *driver) Reader(ctx context.Context, path string, offset int64) (io.ReadCloser, error) &#123;</span><br><span class="line">   152:         file, err := os.OpenFile(d.fullPath(path), os.O_RDONLY, 0644)</span><br><span class="line">=&gt; 153:         if err != nil &#123;</span><br><span class="line">   154:                 if os.IsNotExist(err) &#123;</span><br><span class="line">   155:                         return nil, storagedriver.PathNotFoundError&#123;Path: path&#125;</span><br><span class="line">   156:                 &#125;</span><br><span class="line">   157:</span><br><span class="line">   158:                 return nil, err</span><br><span class="line">(dlv) locals</span><br><span class="line">err = error(*io/fs.PathError) 0xc0003e0e48</span><br><span class="line">file = *os.File nil</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobStore).<span class="built_in">readlink</span>() /root/go/src/github.com/docker/distribution/registry/storage/blobstore.go:144 (PC: 0xb9b009)</span></span><br><span class="line">   139:</span><br><span class="line">   140: // readlink returns the linked digest at path.</span><br><span class="line">   141: func (bs *blobStore) readlink(ctx context.Context, path string) (digest.Digest, error) &#123;</span><br><span class="line">   142:         content, err := bs.driver.GetContent(ctx, path)</span><br><span class="line">   143:         if err != nil &#123;</span><br><span class="line">=&gt; 144:                 return &quot;&quot;, err</span><br><span class="line">   145:         &#125;</span><br><span class="line">   146:</span><br><span class="line">   147:         linked, err := digest.Parse(string(content))</span><br><span class="line">   148:         if err != nil &#123;</span><br><span class="line">   149:                 return &quot;&quot;, err</span><br><span class="line">(dlv) locals</span><br><span class="line">content = []uint8 len: 0, cap: 0, nil</span><br><span class="line">err = error(github.com/docker/distribution/registry/storage/driver.PathNotFoundError) &#123;Path: &quot;/docker/registry/v2/repositories/library/alpine/_layers/sha256/4...+68 more&quot;, DriverName: &quot;filesystem&quot;&#125;</span><br><span class="line">(dlv) p err</span><br><span class="line">error(github.com/docker/distribution/registry/storage/driver.PathNotFoundError) &#123;</span><br><span class="line">        Path: &quot;/docker/registry/v2/repositories/library/alpine/_layers/sha256/44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885/link&quot;,</span><br><span class="line">        DriverName: &quot;filesystem&quot;,&#125;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*linkedBlobStatter).Stat() /root/go/src/github.com/docker/distribution/registry/storage/linkedblobstore.go:395 (PC: 0xbaa5ca)</span></span><br><span class="line">   390:                 if err == nil &#123;</span><br><span class="line">   391:                         found = true</span><br><span class="line">   392:                         break // success!</span><br><span class="line">   393:                 &#125;</span><br><span class="line">   394:</span><br><span class="line">=&gt; 395:                 switch err := err.(type) &#123;</span><br><span class="line">   396:                 case driver.PathNotFoundError:</span><br><span class="line">   397:                         // do nothing, just move to the next linkPathFn</span><br><span class="line">   398:                 default:</span><br><span class="line">   399:                         return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">   400:                 &#125;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) s</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache.(*cachedBlobStatter).Stat() /root/go/src/github.com/docker/distribution/registry/storage/cache/cachedblobdescriptorstore.go:86 (PC: 0xb74f3a)</span></span><br><span class="line">Values returned:</span><br><span class="line">        ~r0: github.com/docker/distribution.Descriptor &#123;</span><br><span class="line">                MediaType: &quot;&quot;,</span><br><span class="line">                Size: 0,</span><br><span class="line">                Digest: &quot;&quot;,</span><br><span class="line">                URLs: []string len: 0, cap: 0, nil,</span><br><span class="line">                Annotations: map[string]string nil,</span><br><span class="line">                Platform: *github.com/docker/distribution/vendor/github.com/opencontainers/image-spec/specs-go/v1.Platform nil,&#125;</span><br><span class="line">        ~r1: error(*errors.errorString) *&#123;</span><br><span class="line">                s: &quot;unknown blob&quot;,&#125;</span><br><span class="line"></span><br><span class="line">    81: fallback:</span><br><span class="line">    82:         cacheCount.WithValues(&quot;Miss&quot;).Inc(1)</span><br><span class="line">    83:         if cbds.tracker != nil &#123;</span><br><span class="line">    84:                 cbds.tracker.Miss()</span><br><span class="line">    85:         &#125;</span><br><span class="line">=&gt;  86:         desc, err = cbds.backend.Stat(ctx, dgst)</span><br><span class="line">    87:         if err != nil &#123;</span><br><span class="line">    88:                 return desc, err</span><br><span class="line">    89:         &#125;</span><br><span class="line">    90:</span><br><span class="line">    91:         if err := cbds.cache.SetDescriptor(ctx, dgst, desc); err != nil &#123;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/proxy.(*proxyBlobStore).Stat() /root/go/src/github.com/docker/distribution/registry/proxy/proxyblobstore.go:169 (PC: 0xbe318e)</span></span><br><span class="line">   164:</span><br><span class="line">   165:         if err != distribution.ErrBlobUnknown &#123;</span><br><span class="line">   166:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">   167:         &#125;</span><br><span class="line">   168:</span><br><span class="line">=&gt; 169:         if err := pbs.authChallenger.tryEstablishChallenges(ctx); err != nil &#123;</span><br><span class="line">   170:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">   171:         &#125;</span><br><span class="line">   172:</span><br><span class="line">   173:         return pbs.remoteStore.Stat(ctx, dgst)</span><br><span class="line">   174: &#125;</span><br><span class="line">(dlv) s</span><br><span class="line">DEBU[1994] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=08f6ce04-c812-4ae8-aeb6-40b750dd355a service=registry trace.duration=39.592µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=e0d4c1b9-1659-4fad-a556-aeec6b74d624 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/proxy.(*remoteAuthChallenger).tryEstablishChallenges() /root/go/src/github.com/docker/distribution/registry/proxy/proxyregistry.go:217 (PC: 0xbe7696)</span></span><br><span class="line">   212: func (r *remoteAuthChallenger) challengeManager() challenge.Manager &#123;</span><br><span class="line">   213:         return r.cm</span><br><span class="line">   214: &#125;</span><br><span class="line">   215:</span><br><span class="line">   216: // tryEstablishChallenges will attempt to get a challenge type for the upstream if none currently exist</span><br><span class="line">=&gt; 217: func (r *remoteAuthChallenger) tryEstablishChallenges(ctx context.Context) error &#123;</span><br><span class="line">   218:         r.Lock()</span><br><span class="line">   219:         defer r.Unlock()</span><br><span class="line">   220:</span><br><span class="line">   221:         remoteURL := r.remoteURL</span><br><span class="line">   222:         remoteURL.Path = &quot;/v2/&quot;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tryEstablishChallenges 只是尝试建立连接，还没有真正获取数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">真正获取数据，则是由后面的</span> </span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/client.(*blobStatter).Stat() /root/go/src/github.com/docker/distribution/registry/client/repository.go:794 (PC: 0xbd7411)</span></span><br><span class="line">   789: func (bs *blobStatter) Stat(ctx context.Context, dgst digest.Digest) (distribution.Descriptor, error) &#123;</span><br><span class="line">   790:         ref, err := reference.WithDigest(bs.name, dgst)</span><br><span class="line">   791:         if err != nil &#123;</span><br><span class="line">   792:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">   793:         &#125;</span><br><span class="line">=&gt; 794:         u, err := bs.ub.BuildBlobURL(ref)</span><br><span class="line">   795:         if err != nil &#123;</span><br><span class="line">   796:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">   797:         &#125;</span><br><span class="line">   798:</span><br><span class="line">   799:         resp, err := bs.client.Head(u)</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取数据前，需要指定 scope 和 生成 token</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/client/auth.(*tokenHandler).getToken() /root/go/src/github.com/docker/distribution/registry/client/auth/session.go:278 (PC: 0xbda455)</span></span><br><span class="line">   273:         defer th.tokenLock.Unlock()</span><br><span class="line">   274:         scopes := make([]string, 0, len(th.scopes)+len(additionalScopes))</span><br><span class="line">   275:         for _, scope := range th.scopes &#123;</span><br><span class="line">   276:                 scopes = append(scopes, scope.String())</span><br><span class="line">   277:         &#125;</span><br><span class="line">=&gt; 278:         var addedScopes bool</span><br><span class="line">   279:         for _, scope := range additionalScopes &#123;</span><br><span class="line">   280:                 if hasScope(scopes, scope) &#123;</span><br><span class="line">   281:                         continue</span><br><span class="line">   282:                 &#125;</span><br><span class="line">   283:                 scopes = append(scopes, scope)</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过 th.creds 中存储的账密像 proxy 获取 token</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/client/auth.(*tokenHandler).fetchToken() /root/go/src/github.com/docker/distribution/registry/client/auth/session.go:494 (PC: 0xbdceb2)</span></span><br><span class="line">   489:</span><br><span class="line">   490:         service := params[&quot;service&quot;]</span><br><span class="line">   491:</span><br><span class="line">   492:         var refreshToken string</span><br><span class="line">   493:</span><br><span class="line">=&gt; 494:         if th.creds != nil &#123;</span><br><span class="line">   495:                 refreshToken = th.creds.RefreshToken(realmURL, service)</span><br><span class="line">   496:         &#125;</span><br><span class="line">   497:</span><br><span class="line">   498:         if refreshToken != &quot;&quot; || th.forceOAuth &#123;</span><br><span class="line">   499:                 return th.fetchTokenWithOAuth(realmURL, refreshToken, service, scopes)</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">请求过程中则是将 username 和 password 进行 <span class="built_in">base64</span> 加密</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">net/http.basicAuth() /usr/local/go/src/net/http/client.go:423 (PC: 0x869b60)</span></span><br><span class="line">   418: // &quot;To receive authorization, the client sends the userid and password,</span><br><span class="line">   419: // separated by a single colon (&quot;:&quot;) character, within a base64</span><br><span class="line">   420: // encoded string in the credentials.&quot;</span><br><span class="line">   421: // It is not meant to be urlencoded.</span><br><span class="line">   422: func basicAuth(username, password string) string &#123;</span><br><span class="line">=&gt; 423:         auth := username + &quot;:&quot; + password</span><br><span class="line">   424:         return base64.StdEncoding.EncodeToString([]byte(auth))</span><br><span class="line">   425: &#125;</span><br><span class="line">   426:</span><br><span class="line">   427: // Get issues a GET to the specified URL. If the response is one of</span><br><span class="line">   428: // the following redirect codes, Get follows the redirect, up to a</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发起请求获取数据</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/client/transport.(*transport).RoundTrip() /root/go/src/github.com/docker/distribution/registry/client/transport/transport.go:56 (PC: 0xbc747f)</span></span><br><span class="line">    51: // access token. If no token exists or token is expired,</span><br><span class="line">    52: // tries to refresh/fetch a new token.</span><br><span class="line">    53: func (t *transport) RoundTrip(req *http.Request) (*http.Response, error) &#123;</span><br><span class="line">    54:         req2 := cloneRequest(req)</span><br><span class="line">    55:         for _, modifier := range t.Modifiers &#123;</span><br><span class="line">=&gt;  56:                 if err := modifier.ModifyRequest(req2); err != nil &#123;</span><br><span class="line">    57:                         return nil, err</span><br><span class="line">    58:                 &#125;</span><br><span class="line">    59:         &#125;</span><br><span class="line">    60:</span><br><span class="line">    61:         t.setModReq(req, req2)</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据存储前，会走到 cache 逻辑，此时 mirror 本地存储还没有数据</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache/memory.(*inMemoryBlobDescriptorCacheProvider).SetDescriptor() /root/go/src/github.com/docker/distribution/registry/storage/cache/memory/memory.go:55 (PC: 0xbc8ba9)</span></span><br><span class="line">    50:</span><br><span class="line">    51: func (imbdcp *inMemoryBlobDescriptorCacheProvider) SetDescriptor(ctx context.Context, dgst digest.Digest, desc distribution.Descriptor) error &#123;</span><br><span class="line">    52:         _, err := imbdcp.Stat(ctx, dgst)</span><br><span class="line">    53:         if err == distribution.ErrBlobUnknown &#123;</span><br><span class="line">    54:</span><br><span class="line">=&gt;  55:                 if dgst.Algorithm() != desc.Digest.Algorithm() &amp;&amp; dgst != desc.Digest &#123;</span><br><span class="line">    56:                         // if the digests differ, set the other canonical mapping</span><br><span class="line">    57:                         if err := imbdcp.global.SetDescriptor(ctx, desc.Digest, desc); err != nil &#123;</span><br><span class="line">    58:                                 return err</span><br><span class="line">    59:                         &#125;</span><br><span class="line">    60:                 &#125;</span><br><span class="line">(dlv) n</span><br><span class="line">DEBU[6818] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=08f6ce04-c812-4ae8-aeb6-40b750dd355a service=registry trace.duration=36.344µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=7c42ff89-d43a-40f5-b91a-32d92f869377 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache/memory.(*inMemoryBlobDescriptorCacheProvider).SetDescriptor() /root/go/src/github.com/docker/distribution/registry/storage/cache/memory/memory.go:63 (PC: 0xbc8d32)</span></span><br><span class="line">    58:                                 return err</span><br><span class="line">    59:                         &#125;</span><br><span class="line">    60:                 &#125;</span><br><span class="line">    61:</span><br><span class="line">    62:                 // unknown, just set it</span><br><span class="line">=&gt;  63:                 return imbdcp.global.SetDescriptor(ctx, dgst, desc)</span><br><span class="line">    64:         &#125;</span><br><span class="line">    65:</span><br><span class="line">    66:         // we already know it, do nothing</span><br><span class="line">    67:         return err</span><br><span class="line">    68: &#125;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">首次和二次 pull 走相同的逻辑，在 <span class="built_in">readlink</span> 时出现不同的处理</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobStore).<span class="built_in">readlink</span>() /root/go/src/github.com/docker/distribution/registry/storage/blobstore.go:144 (PC: 0xb9b009)</span></span><br><span class="line">   139:</span><br><span class="line">   140: // readlink returns the linked digest at path.</span><br><span class="line">   141: func (bs *blobStore) readlink(ctx context.Context, path string) (digest.Digest, error) &#123;</span><br><span class="line">   142:         content, err := bs.driver.GetContent(ctx, path)</span><br><span class="line">   143:         if err != nil &#123;</span><br><span class="line">=&gt; 144:                 return &quot;&quot;, err</span><br><span class="line">   145:         &#125;</span><br><span class="line">   146:</span><br><span class="line">   147:         linked, err := digest.Parse(string(content))</span><br><span class="line">   148:         if err != nil &#123;</span><br><span class="line">   149:                 return &quot;&quot;, err</span><br><span class="line">(dlv) s</span><br><span class="line">DEBU[7454] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=08f6ce04-c812-4ae8-aeb6-40b750dd355a service=registry trace.duration=36.833µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=40c6e2e6-6848-406b-b055-7111293ad295 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*linkedBlobStatter).resolveWithLinkFunc() /root/go/src/github.com/docker/distribution/registry/storage/linkedblobstore.go:449 (PC: 0xbaafc9)</span></span><br><span class="line">Values returned:</span><br><span class="line">        ~r0: &quot;&quot;</span><br><span class="line">        ~r1: error(github.com/docker/distribution/registry/storage/driver.PathNotFoundError) &#123;</span><br><span class="line">                Path: &quot;/docker/registry/v2/repositories/library/alpine/_layers/sha256/44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885/link&quot;,</span><br><span class="line">                DriverName: &quot;filesystem&quot;,&#125;</span><br><span class="line"></span><br><span class="line">   444:         blobLinkPath, err := linkPathFn(lbs.repository.Named().Name(), dgst)</span><br><span class="line">   445:         if err != nil &#123;</span><br><span class="line">   446:                 return &quot;&quot;, err</span><br><span class="line">   447:         &#125;</span><br><span class="line">   448:</span><br><span class="line">=&gt; 449:         return lbs.blobStore.readlink(ctx, blobLinkPath)</span><br><span class="line">   450: &#125;</span><br><span class="line">   451:</span><br><span class="line">   452: func (lbs *linkedBlobStatter) SetDescriptor(ctx context.Context, dgst digest.Digest, desc distribution.Descriptor) error &#123;</span><br><span class="line">   453:         // The canonical descriptor for a blob is set at the commit phase of upload</span><br><span class="line">   454:         return nil</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据 uploadDataPathSpec ，获取数据写入到本地</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*linkedBlobStore).Create() /root/go/src/github.com/docker/distribution/registry/storage/linkedblobstore.go:156 (PC: 0xba7a55)</span></span><br><span class="line">   151:         path, err := pathFor(uploadDataPathSpec&#123;</span><br><span class="line">   152:                 name: lbs.repository.Named().Name(),</span><br><span class="line">   153:                 id:   uuid,</span><br><span class="line">   154:         &#125;)</span><br><span class="line">   155:</span><br><span class="line">=&gt; 156:         if err != nil &#123;</span><br><span class="line">   157:                 return nil, err</span><br><span class="line">   158:         &#125;</span><br><span class="line">   159:</span><br><span class="line">   160:         startedAtPath, err := pathFor(uploadStartedAtPathSpec&#123;</span><br><span class="line">   161:                 name: lbs.repository.Named().Name(),</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入前的最后准备工作</span></span><br><span class="line">(dlv) locals</span><br><span class="line">opts = github.com/docker/distribution.CreateOptions &#123;Mount: (*&quot;struct &#123; ShouldMount bool; From github.com/docker/distribution/vendor/github.com/distribution/reference.Canonical; Stat *github.com/docker/distribution.Descriptor &#125;&quot;)(0xc0002a0320)&#125;</span><br><span class="line">uuid = &quot;fd96c777-cacd-4dbf-954b-17f98861599c&quot;</span><br><span class="line">startedAt = time.Time(2025-02-18T12:00:35Z)&#123;wall: 538346343, ext: 63875476835, loc: *time.Location nil&#125;</span><br><span class="line">err = error nil</span><br><span class="line">path = &quot;/docker/registry/v2/repositories/library/alpine/_uploads/fd96c77...+34 more&quot;</span><br><span class="line">startedAtPath = &quot;/docker/registry/v2/repositories/library/alpine/_uploads/fd96c77...+39 more&quot;</span><br><span class="line">(dlv) p path</span><br><span class="line">&quot;/docker/registry/v2/repositories/library/alpine/_uploads/fd96c777-cacd-4dbf-954b-17f98861599c/data&quot;</span><br><span class="line">(dlv) p startedAtPath</span><br><span class="line">&quot;/docker/registry/v2/repositories/library/alpine/_uploads/fd96c777-cacd-4dbf-954b-17f98861599c/startedat&quot;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lbs.blobStore.driver.PutContent 往 startedat 写入时间</span></span><br><span class="line">(dlv) s</span><br><span class="line">DEBU[8811] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=08f6ce04-c812-4ae8-aeb6-40b750dd355a service=registry trace.duration=16.772555154s trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=ad590e58-4273-4ea7-a6e1-d79fad18fca1 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*linkedBlobStore).Create() /root/go/src/github.com/docker/distribution/registry/storage/linkedblobstore.go:174 (PC: 0xba7d84)</span></span><br><span class="line">   169:         // Write a startedat file for this upload</span><br><span class="line">   170:         if err := lbs.blobStore.driver.PutContent(ctx, startedAtPath, []byte(startedAt.Format(time.RFC3339))); err != nil &#123;</span><br><span class="line">   171:                 return nil, err</span><br><span class="line">   172:         &#125;</span><br><span class="line">   173:</span><br><span class="line">=&gt; 174:         return lbs.newBlobUpload(ctx, uuid, path, startedAt, false)</span><br><span class="line">   175: &#125;</span><br><span class="line">   176:</span><br><span class="line">   177: func (lbs *linkedBlobStore) Resume(ctx context.Context, id string) (distribution.BlobWriter, error) &#123;</span><br><span class="line">   178:         dcontext.GetLogger(ctx).Debug(&quot;(*linkedBlobStore).Resume&quot;)</span><br><span class="line">   179:</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">真正写入文件 lbs.newBlobUpload(ctx, uuid, path, startedAt, <span class="literal">false</span>)</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/proxy.(*proxyBlobStore).copyContent() /root/go/src/github.com/docker/distribution/registry/proxy/proxyblobstore.go:46 (PC: 0xbe141e)</span></span><br><span class="line">    41:         desc, err := pbs.remoteStore.Stat(ctx, dgst)</span><br><span class="line">    42:         if err != nil &#123;</span><br><span class="line">    43:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">    44:         &#125;</span><br><span class="line">    45:</span><br><span class="line">=&gt;  46:         if w, ok := writer.(http.ResponseWriter); ok &#123;</span><br><span class="line">    47:                 setResponseHeaders(w, desc.Size, desc.MediaType, dgst)</span><br><span class="line">    48:         &#125;</span><br><span class="line">    49:</span><br><span class="line">    50:         remoteReader, err := pbs.remoteStore.Open(ctx, dgst)</span><br><span class="line">    51:         if err != nil &#123;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">调用  io.CopyN(writer, remoteReader, desc.Size) 后，uuid data 才会有内容</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/proxy.(*proxyBlobStore).copyContent() /root/go/src/github.com/docker/distribution/registry/proxy/proxyblobstore.go:57 (PC: 0xbe17a5)</span></span><br><span class="line">    52:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">    53:         &#125;</span><br><span class="line">    54:</span><br><span class="line">    55:         defer remoteReader.Close()</span><br><span class="line">    56:</span><br><span class="line">=&gt;  57:         _, err = io.CopyN(writer, remoteReader, desc.Size)</span><br><span class="line">    58:         if err != nil &#123;</span><br><span class="line">    59:                 return distribution.Descriptor&#123;&#125;, err</span><br><span class="line">    60:         &#125;</span><br><span class="line">    61:</span><br><span class="line">    62:         proxyMetrics.BlobPush(uint64(desc.Size))</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最后调用 moveBlob，从临时文件夹中移除</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobWriter).moveBlob() /root/go/src/github.com/docker/distribution/registry/storage/blobwriter.go:305 (PC: 0xb9e0b6)</span></span><br><span class="line">   300:         if err != nil &#123;</span><br><span class="line">   301:                 return err</span><br><span class="line">   302:         &#125;</span><br><span class="line">   303:</span><br><span class="line">   304:         // Check for existence</span><br><span class="line">=&gt; 305:         if _, err := bw.blobStore.driver.Stat(ctx, blobPath); err != nil &#123;</span><br><span class="line">   306:                 switch err := err.(type) &#123;</span><br><span class="line">   307:                 case storagedriver.PathNotFoundError:</span><br><span class="line">   308:                         break // ensure that it doesn&#x27;t exist.</span><br><span class="line">   309:                 default:</span><br><span class="line">   310:                         return err</span><br><span class="line">(dlv) </span><br></pre></td></tr></table></figure>
</li>
<li><p>如果本地缓存有，那么就会从本地直接返回</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">走下面 err = nil 的逻辑</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobStore).<span class="built_in">readlink</span>() /root/go/src/github.com/docker/distribution/registry/storage/blobstore.go:143 (PC: 0xb9b002)</span></span><br><span class="line">   138: &#125;</span><br><span class="line">   139:</span><br><span class="line">   140: // readlink returns the linked digest at path.</span><br><span class="line">   141: func (bs *blobStore) readlink(ctx context.Context, path string) (digest.Digest, error) &#123;</span><br><span class="line">   142:         content, err := bs.driver.GetContent(ctx, path)</span><br><span class="line">=&gt; 143:         if err != nil &#123;</span><br><span class="line">   144:                 return &quot;&quot;, err</span><br><span class="line">   145:         &#125;</span><br><span class="line">   146:</span><br><span class="line">   147:         linked, err := digest.Parse(string(content))</span><br><span class="line">   148:         if err != nil &#123;</span><br><span class="line">(dlv) </span><br></pre></td></tr></table></figure>
</li>
<li><p>随后将信息写入 cache，信息如下</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache/memory.(*mapBlobDescriptorCache).SetDescriptor() ./registry/storage/cache/memory/memory.go:178 (PC: 0xbc9ef3)</span></span><br><span class="line">   173:</span><br><span class="line">   174:         mbdc.mu.Lock()</span><br><span class="line">   175:         defer mbdc.mu.Unlock()</span><br><span class="line">   176:</span><br><span class="line">   177:         mbdc.descriptors[dgst] = desc</span><br><span class="line">=&gt; 178:         return nil</span><br><span class="line">   179: &#125;</span><br><span class="line">(dlv) p mbdc</span><br><span class="line">(&quot;*github.com/docker/distribution/registry/storage/cache/memory.mapBlobDescriptorCache&quot;)(0xc00036ec40)</span><br><span class="line">*github.com/docker/distribution/registry/storage/cache/memory.mapBlobDescriptorCache &#123;</span><br><span class="line">        descriptors: map[github.com/docker/distribution/vendor/github.com/opencontainers/go-digest.Digest]github.com/docker/distribution.Descriptor [</span><br><span class="line">                &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;: (*&quot;github.com/docker/distribution.Descriptor&quot;)(0xc0000a63a0), </span><br><span class="line">        ],</span><br><span class="line">        mu: sync.RWMutex &#123;</span><br><span class="line">                w: (*sync.Mutex)(0xc00036ec48),</span><br><span class="line">                writerSem: 0,</span><br><span class="line">                readerSem: 0,</span><br><span class="line">                readerCount: (*&quot;sync/atomic.Int32&quot;)(0xc00036ec58),</span><br><span class="line">                readerWait: (*&quot;sync/atomic.Int32&quot;)(0xc00036ec5c),&#125;,&#125;</span><br><span class="line">(dlv) p mbdc.descriptors</span><br><span class="line">map[github.com/docker/distribution/vendor/github.com/opencontainers/go-digest.Digest]github.com/docker/distribution.Descriptor [</span><br><span class="line">        &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;: &#123;</span><br><span class="line">                MediaType: &quot;application/octet-stream&quot;,</span><br><span class="line">                Size: 3418409,</span><br><span class="line">                Digest: &quot;sha256:44cf07d57ee4424189f012074a59110ee2065adfdde9c7d9826bebdffce0a885&quot;,</span><br><span class="line">                URLs: []string len: 0, cap: 0, nil,</span><br><span class="line">                Annotations: map[string]string nil,</span><br><span class="line">                Platform: *github.com/docker/distribution/vendor/github.com/opencontainers/image-spec/specs-go/v1.Platform nil,&#125;, </span><br><span class="line">]</span><br><span class="line">(dlv) s</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache/memory.(*inMemoryBlobDescriptorCacheProvider).SetDescriptor() ./registry/storage/cache/memory/memory.go:63 (PC: 0xbc8d9e)</span></span><br><span class="line">Values returned:</span><br><span class="line">        ~r0: error nil</span><br><span class="line"></span><br><span class="line">    58:                                 return err</span><br><span class="line">    59:                         &#125;</span><br><span class="line">    60:                 &#125;</span><br><span class="line">    61:</span><br><span class="line">    62:                 // unknown, just set it</span><br><span class="line">=&gt;  63:                 return imbdcp.global.SetDescriptor(ctx, dgst, desc)</span><br><span class="line">    64:         &#125;</span><br><span class="line">    65:</span><br><span class="line">    66:         // we already know it, do nothing</span><br><span class="line">    67:         return err</span><br><span class="line">    68: &#125;</span><br><span class="line">(dlv) s</span><br><span class="line">DEBU[53825] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=5d53b068-4ba6-440a-8a3b-15a6a6dd7518 service=registry trace.duration=60.197µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=22bba5cd-3f4b-4609-8977-5ce26ad5bb7f trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line">DEBU[53825] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=5d53b068-4ba6-440a-8a3b-15a6a6dd7518 service=registry trace.duration=12.473µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=651c9e73-4c43-45f9-9134-5b9dbb5fcce6 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage/cache.(*cachedBlobStatter).Stat() ./registry/storage/cache/cachedblobdescriptorstore.go:91 (PC: 0xb750bc)</span></span><br><span class="line">Values returned:</span><br><span class="line">        ~r0: error nil</span><br><span class="line"></span><br><span class="line">    86:         desc, err = cbds.backend.Stat(ctx, dgst)</span><br><span class="line">    87:         if err != nil &#123;</span><br><span class="line">    88:                 return desc, err</span><br><span class="line">    89:         &#125;</span><br><span class="line">    90:</span><br><span class="line">=&gt;  91:         if err := cbds.cache.SetDescriptor(ctx, dgst, desc); err != nil &#123;</span><br><span class="line">    92:                 logErrorf(ctx, cbds.tracker, &quot;error adding descriptor %v to cache: %v&quot;, desc.Digest, err)</span><br><span class="line">    93:         &#125;</span><br><span class="line">    94:</span><br><span class="line">    95:         return desc, err</span><br><span class="line">    96:</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="GetBlob-blobs-ServeBlob-bh-w-r-desc-Digest"><a href="#GetBlob-blobs-ServeBlob-bh-w-r-desc-Digest" class="headerlink" title="GetBlob  blobs.ServeBlob(bh, w, r, desc.Digest)"></a>GetBlob  blobs.ServeBlob(bh, w, r, desc.Digest)</h2><ul>
<li><p>经过一系列调用，会到这个方法，可以看到，这个是真正取值的时候</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobStore).path() ./registry/storage/blobstore.go:120 (PC: 0xb9ab93)</span></span><br><span class="line">   115:         &#125;)</span><br><span class="line">   116: &#125;</span><br><span class="line">   117:</span><br><span class="line">   118: // path returns the canonical path for the blob identified by digest. The blob</span><br><span class="line">   119: // may or may not exist.</span><br><span class="line">=&gt; 120: func (bs *blobStore) path(dgst digest.Digest) (string, error) &#123;</span><br><span class="line">   121:         bp, err := pathFor(blobDataPathSpec&#123;</span><br><span class="line">   122:                 digest: dgst,</span><br><span class="line">   123:         &#125;)</span><br><span class="line">   124:</span><br><span class="line">   125:         if err != nil &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) s</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.pathFor() ./registry/storage/paths.go:221 (PC: 0xbb2b46)</span></span><br><span class="line">   216:                 &#125;</span><br><span class="line">   217:</span><br><span class="line">   218:                 blobPathPrefix := append(rootPrefix, &quot;blobs&quot;)</span><br><span class="line">   219:                 return path.Join(append(blobPathPrefix, components...)...), nil</span><br><span class="line">   220:         case blobDataPathSpec:</span><br><span class="line">=&gt; 221:                 components, err := digestPathComponents(v.digest, true)</span><br><span class="line">   222:                 if err != nil &#123;</span><br><span class="line">   223:                         return &quot;&quot;, err</span><br><span class="line">   224:                 &#125;</span><br><span class="line">   225:</span><br><span class="line">   226:                 components = append(components, &quot;data&quot;)</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobServer).ServeBlob() ./registry/storage/blobserver.go:45 (PC: 0xb98eca)</span></span><br><span class="line">    40:                 case nil:</span><br><span class="line">    41:                         // Redirect to storage URL.</span><br><span class="line">    42:                         http.Redirect(w, r, redirectURL, http.StatusTemporaryRedirect)</span><br><span class="line">    43:                         return err</span><br><span class="line">    44:</span><br><span class="line">=&gt;  45:                 case driver.ErrUnsupportedMethod:</span><br><span class="line">    46:                         // Fallback to serving the content directly.</span><br><span class="line">    47:                 default:</span><br><span class="line">    48:                         // Some unexpected error.</span><br><span class="line">    49:                         return err</span><br><span class="line">    50:                 &#125;</span><br><span class="line">(dlv) s</span><br><span class="line">DEBU[63862] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=5d53b068-4ba6-440a-8a3b-15a6a6dd7518 service=registry trace.duration=54.521µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=e7d8e37c-ff6b-4eeb-ab84-8afe24864518 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobServer).ServeBlob() ./registry/storage/blobserver.go:39 (PC: 0xb98ef9)</span></span><br><span class="line">    34:                 return err</span><br><span class="line">    35:         &#125;</span><br><span class="line">    36:</span><br><span class="line">    37:         if bs.redirect &#123;</span><br><span class="line">    38:                 redirectURL, err := bs.driver.URLFor(ctx, path, map[string]interface&#123;&#125;&#123;&quot;method&quot;: r.Method&#125;)</span><br><span class="line">=&gt;  39:                 switch err.(type) &#123;</span><br><span class="line">    40:                 case nil:</span><br><span class="line">    41:                         // Redirect to storage URL.</span><br><span class="line">    42:                         http.Redirect(w, r, redirectURL, http.StatusTemporaryRedirect)</span><br><span class="line">    43:                         return err</span><br><span class="line">    44:</span><br><span class="line">(dlv) s</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobServer).ServeBlob() ./registry/storage/blobserver.go:53 (PC: 0xb98fc2)</span></span><br><span class="line">    48:                         // Some unexpected error.</span><br><span class="line">    49:                         return err</span><br><span class="line">    50:                 &#125;</span><br><span class="line">    51:         &#125;</span><br><span class="line">    52:</span><br><span class="line">=&gt;  53:         br, err := newFileReader(ctx, bs.driver, path, desc.Size)</span><br><span class="line">    54:         if err != nil &#123;</span><br><span class="line">    55:                 return err</span><br><span class="line">    56:         &#125;</span><br><span class="line">    57:         defer br.Close()</span><br><span class="line">    58:</span><br><span class="line">(dlv) </span><br></pre></td></tr></table></figure>
</li>
<li><p>文件传输</p>
<figure class="highlight shell"><figcaption><span>hider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/distribution/registry/storage.(*blobServer).ServeBlob() ./registry/storage/blobserver.go:76 (PC: 0xb99630)</span></span><br><span class="line">    71:         if w.Header().Get(&quot;Content-Length&quot;) == &quot;&quot; &#123;</span><br><span class="line">    72:                 // Set the content length if not already set.</span><br><span class="line">    73:                 w.Header().Set(&quot;Content-Length&quot;, fmt.Sprint(desc.Size))</span><br><span class="line">    74:         &#125;</span><br><span class="line">    75:</span><br><span class="line">=&gt;  76:         http.ServeContent(w, r, desc.Digest.String(), time.Time&#123;&#125;, br)</span><br><span class="line">    77:         return nil</span><br><span class="line">    78: &#125;</span><br><span class="line">(dlv) s</span><br><span class="line">DEBU[64560] filesystem.Stat(&quot;/&quot;)                          environment=development go.version=go1.24.0 instance.id=5d53b068-4ba6-440a-8a3b-15a6a6dd7518 service=registry trace.duration=70.19µs trace.file=&quot;/root/go/src/github.com/docker/distribution/registry/storage/driver/base/base.go&quot; trace.func=&quot;github.com/docker/distribution/registry/storage/driver/base.(*Base).Stat&quot; trace.id=b8c1cf63-9f39-4805-9b4b-5258f1c2be67 trace.line=155 version=&quot;v2.8.3+unknown&quot;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">net/http.ServeContent() /usr/local/go/src/net/http/fs.go:240 (PC: 0x872553)</span></span><br><span class="line">   235: // handling an invalid range request), ServeContent responds with an</span><br><span class="line">   236: // error message. By default, ServeContent strips the Cache-Control,</span><br><span class="line">   237: // Content-Encoding, ETag, and Last-Modified headers from error responses.</span><br><span class="line">   238: // The GODEBUG setting httpservecontentkeepheaders=1 causes ServeContent</span><br><span class="line">   239: // to preserve these headers.</span><br><span class="line">=&gt; 240: func ServeContent(w ResponseWriter, req *Request, name string, modtime time.Time, content io.ReadSeeker) &#123;</span><br><span class="line">   241:         sizeFunc := func() (int64, error) &#123;</span><br><span class="line">   242:                 size, err := content.Seek(0, io.SeekEnd)</span><br><span class="line">   243:                 if err != nil &#123;</span><br><span class="line">   244:                         return 0, errSeeker</span><br><span class="line">   245:                 &#125;</span><br><span class="line">(dlv) </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">(dlv) l</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">io.CopyN() /usr/local/go/src/io/io.go:363 (PC: 0x4a29d3)</span></span><br><span class="line">   358: // It returns the number of bytes copied and the earliest</span><br><span class="line">   359: // error encountered while copying.</span><br><span class="line">   360: // On return, written == n if and only if err == nil.</span><br><span class="line">   361: //</span><br><span class="line">   362: // If dst implements [ReaderFrom], the copy is implemented using it.</span><br><span class="line">=&gt; 363: func CopyN(dst Writer, src Reader, n int64) (written int64, err error) &#123;</span><br><span class="line">   364:         written, err = Copy(dst, LimitReader(src, n))</span><br><span class="line">   365:         if written == n &#123;</span><br><span class="line">   366:                 return n, nil</span><br><span class="line">   367:         &#125;</span><br><span class="line">   368:         if written &lt; n &amp;&amp; err == nil &#123;</span><br><span class="line">(dlv) </span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">cv-programmer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://bh.ecel.top/cloud/distribution-02-pull-cache/">http://bh.ecel.top/cloud/distribution-02-pull-cache/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://bh.ecel.top" target="_blank">cv-programmer</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/distribution/">distribution</a><a class="post-meta__tags" href="/tags/registry/">registry</a><a class="post-meta__tags" href="/tags/mirror/">mirror</a></div><div class="post_share"><div class="social-share" data-image="/image/distribution-logo.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/codeLang/Go-07-delve/"><img class="prev-cover" src="/image/go.jpeg" onerror="onerror=null;src='/image/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【Go】07-调试工具 delve</div></div></a></div><div class="next-post pull-right"><a href="/codeLang/Go-06-cobra/"><img class="next-cover" src="/image/go.jpeg" onerror="onerror=null;src='/image/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【Go】06-Cobra</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/cloud/distribution-01-overview/" title="【Distribution】01-概述"><img class="cover" src="/image/distribution-logo.svg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-11</div><div class="title">【Distribution】01-概述</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/image/avatar.jpg" onerror="this.onerror=null;this.src='/image/friend_404.gif'" alt="avatar"/><div class="author-info__name">cv-programmer</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">126</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cv-programmer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cv-programmer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:usetologin@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TL-DR"><span class="toc-number">1.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-number">2.</span> <span class="toc-text">在开始之前</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-does-it-work"><span class="toc-number">2.1.</span> <span class="toc-text">How does it work?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-if-the-content-changes-on-the-Hub"><span class="toc-number">2.1.1.</span> <span class="toc-text">What if the content changes on the Hub?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What-about-my-disk"><span class="toc-number">2.1.2.</span> <span class="toc-text">What about my disk?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%9C%E5%83%8F-pull"><span class="toc-number">3.</span> <span class="toc-text">镜像 pull</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%93%BE%E8%B7%AF"><span class="toc-number">3.2.</span> <span class="toc-text">请求链路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#delve-%E8%B0%83%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">delve 调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.</span> <span class="toc-text">调试方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GetBlob-desc-err-blobs-Stat-bh-bh-Digest"><span class="toc-number">4.2.</span> <span class="toc-text">GetBlob desc, err :&#x3D; blobs.Stat(bh, bh.Digest)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GetBlob-blobs-ServeBlob-bh-w-r-desc-Digest"><span class="toc-number">4.3.</span> <span class="toc-text">GetBlob  blobs.ServeBlob(bh, w, r, desc.Digest)</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/interview/leetcode-go/" title="用 golang 刷leetcode"><img src="/image/knowledge.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="用 golang 刷leetcode"/></a><div class="content"><a class="title" href="/interview/leetcode-go/" title="用 golang 刷leetcode">用 golang 刷leetcode</a><time datetime="2025-09-14T12:52:51.000Z" title="发表于 2025-09-14 20:52:51">2025-09-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/tools/The-trick-of-ubuntu/" title="Ubuntu 常用技巧"><img src="/image/ubuntu.jpg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="Ubuntu 常用技巧"/></a><div class="content"><a class="title" href="/tools/The-trick-of-ubuntu/" title="Ubuntu 常用技巧">Ubuntu 常用技巧</a><time datetime="2025-05-11T03:17:02.000Z" title="发表于 2025-05-11 11:17:02">2025-05-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/ai/n8n/" title="工作流之 n8n"><img src="/image/n8n-logo.png" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="工作流之 n8n"/></a><div class="content"><a class="title" href="/ai/n8n/" title="工作流之 n8n">工作流之 n8n</a><time datetime="2025-04-04T14:04:06.000Z" title="发表于 2025-04-04 22:04:06">2025-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve"><img src="/image/go.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Go】07-调试工具 delve"/></a><div class="content"><a class="title" href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve">【Go】07-调试工具 delve</a><time datetime="2025-03-01T14:41:51.000Z" title="发表于 2025-03-01 22:41:51">2025-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cloud/distribution-02-pull-cache/" title="【Distribution】02-mirror"><img src="/image/distribution-logo.svg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Distribution】02-mirror"/></a><div class="content"><a class="title" href="/cloud/distribution-02-pull-cache/" title="【Distribution】02-mirror">【Distribution】02-mirror</a><time datetime="2025-01-11T15:38:39.000Z" title="发表于 2025-01-11 23:38:39">2025-01-11</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/image/distribution-logo.svg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By cv-programmer</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>