<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ansible 使用说明 | cv-programmer</title><meta name="keywords" content="Linux,Ansible"><meta name="author" content="cv-programmer"><meta name="copyright" content="cv-programmer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="说明 Ansible 主要通过 ssh 来控制多台机器配置管理，部署应用等，工作流如下   Ansible 与 k8s 可见 Ansible Vs. Kubernetes  Ansible 没有状态的概念，只会根据设定的命令进行执行，直到完成或遇到错误退出 k8s 维护了不同 pod 的状态，有一整套管理机制   The differences between these two products">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible 使用说明">
<meta property="og:url" content="http://bh.ecel.top/tools/The-trick-of-ansible/index.html">
<meta property="og:site_name" content="cv-programmer">
<meta property="og:description" content="说明 Ansible 主要通过 ssh 来控制多台机器配置管理，部署应用等，工作流如下   Ansible 与 k8s 可见 Ansible Vs. Kubernetes  Ansible 没有状态的概念，只会根据设定的命令进行执行，直到完成或遇到错误退出 k8s 维护了不同 pod 的状态，有一整套管理机制   The differences between these two products">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://bh.ecel.top/image/ansible.png">
<meta property="article:published_time" content="2024-04-06T07:11:30.000Z">
<meta property="article:modified_time" content="2024-08-31T14:32:14.326Z">
<meta property="article:author" content="cv-programmer">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Ansible">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://bh.ecel.top/image/ansible.png"><link rel="shortcut icon" href="/image/avatar.jpg"><link rel="canonical" href="http://bh.ecel.top/tools/The-trick-of-ansible/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":10,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-31 22:32:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/image/avatar.jpg" onerror="onerror=null;src='/image/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">91</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">124</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/ansible.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">cv-programmer</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-lock"></i><span> 个人</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/timerest/"><i class="fa-fw fas fa-warning"></i><span> 倒计时</span></a></li><li><a class="site-page" href="/myweb/"><i class="fa-fw fas fa-database"></i><span> 网站</span></a></li><li><a class="site-page" href="/blogs/"><i class="fa-fw fas fa-file-text"></i><span> 博文</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ansible 使用说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-06T07:11:30.000Z" title="发表于 2024-04-06 15:11:30">2024-04-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-31T14:32:14.326Z" title="更新于 2024-08-31 22:32:14">2024-08-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li><p>Ansible 主要通过 ssh 来控制多台机器配置管理，部署应用等，工作流如下</p>
<p><img src="/tools/The-trick-of-ansible/image-20240406152402368.png" alt="image-20240406152402368"></p>
</li>
<li><p>Ansible 与 k8s 可见 <a target="_blank" rel="noopener" href="https://www.simplilearn.com/ansible-vs-kubernetes-article">Ansible Vs. Kubernetes</a></p>
<ul>
<li>Ansible 没有状态的概念，只会根据设定的命令进行执行，直到完成或遇到错误退出</li>
<li>k8s 维护了不同 pod 的状态，有一整套管理机制</li>
</ul>
<blockquote>
<p>The differences between these two products are profound. Ansible is an IT automation tool that deploys software, configures systems, and organizes more complex IT functions such as <strong>rolling updates or continuous deployments</strong>. On the other hand, <strong>Kubernetes is a system designed to orchestrate Docker containers</strong>. It manages workloads and uses nodes to handle scheduling to make sure that their condition matches the users’ expectations.</p>
<p>In other words, Ansible deploys changes to hosts, while Kubernetes manages containers and keeps them working properly.</p>
<p>Ansible is an excellent useful tool for front-end developers, particularly in situations where some programming is required. Kubernetes is best suited to developing larger apps.</p>
<p>Based on the properties of both tools, it’s like comparing apples to oranges. Granted, they’re both DevOps tools that handle configuration management, but the purposes for which they’re used have minimal overlap.</p>
</blockquote>
</li>
<li><p>Ansible 与 salt 可见 <a target="_blank" rel="noopener" href="https://www.redhat.com/en/topics/automation/ansible-vs-salt">Ansible vs. Salt: What you need to know</a> 及 <a target="_blank" rel="noopener" href="https://cloudinfrastructureservices.co.uk/ansible-vs-salt-whats-the-difference/">Ansible vs Salt – What’s the Difference? (Pros and Cons)</a></p>
<ul>
<li>Ansible 是 agentless，只需要在 master 安装相应的工具即可。salt 是 agent-based</li>
<li>Ansible 只有一个 master。salt 可有多个，故障后自动换 master</li>
</ul>
</li>
<li><p>Ansible 基础概念可见 <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/getting_started/basic_concepts.html">Ansible concepts</a></p>
</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><ol>
<li>master 与 slave 都需要安装 <code>openssh-server</code></li>
<li>master 与 slave 间配置了免密登录，可以设置两个 key，一个用于用户平常登录（可设置 passphrase），一个用户 Ansible 发布（不设置 passphrase），免密登录操作可见 <a href="/tools/The-trick-of-ssh/" title="ssh使用说明">ssh使用说明</a></li>
<li>测试容器可见: <a target="_blank" rel="noopener" href="https://github.com/cv-programmer/ansible-learn">https://github.com/cv-programmer/ansible-learn</a></li>
</ol>
<h2 id="Ansible-安装"><a href="#Ansible-安装" class="headerlink" title="Ansible 安装"></a>Ansible 安装</h2><ul>
<li>master 机器: <code>pip install ansible</code>，或者使用包管理工具安装，如 Ubuntu 下可使用 <code>apt install ansible</code></li>
<li>slave 机器不需要操作</li>
</ul>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><ul>
<li><p>假设 master IP 为 172.28.0.2，并有两台 slave 机器，IP 分别为 172.28.0.3 和 172.28.0.4</p>
</li>
<li><p>设置的私钥为 <code>~/.ssh/ansible</code></p>
</li>
<li><p>编写 ansible inventory 文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~/ansible-example</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 master 机器执行以下命令，即可<strong>测试连通性</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all --key-file ~/.ssh/ansible -i ~/ansible-example -m ping </span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240413161935052.png" alt="image-20240413161935052"></p>
</li>
<li><p>配置文件简化操作，通过在默认配置文件中设置，可以减少命令行输入，此时只需要输入 <code>ansible all -m ping</code> 即可，可以加上 <code>interpreter_python = /usr/bin/python3.11</code> 解决告警</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible.cfg</span></span><br><span class="line">[defaults]</span><br><span class="line">inventory = ansible-example</span><br><span class="line">private_key_file = ~/.ssh/ansible</span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240413162950807.png" alt="image-20240413162950807"></p>
</li>
<li><p>安装 git，<code>ansible all -m tdnf name=git</code></p>
<p><img src="/tools/The-trick-of-ansible/image-20240413202639884.png" alt="image-20240413202639884"></p>
</li>
</ul>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><ul>
<li>检查连通性: <code>ansible all -m ping</code></li>
<li>查看配置文件中的 slave: <code>ansible all --list-hosts</code></li>
<li>查看连接 slave信息: <code>ansible all -m gather_facts</code>，如果查看特定 host，后跟 <code>--limit [ip]</code></li>
<li>安装软件: <code>ansible all -m [package-manager] name=[software]</code>。其中<code>package-manager</code>是目标 Host 包管理工具，如果是 Ubuntu，则使用 <code>apt</code>，<code>Centos</code>使用 <code>yum</code>，<code>photon</code>使用<code>tdnf</code><ul>
<li>如果权限不足，需要加上<code>--become --ask-become-pass</code></li>
</ul>
</li>
</ul>
<h1 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h1><ul>
<li>使用 <code>yaml</code> 来定义一系列行为，简化操作成本</li>
</ul>
<h2 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><ul>
<li><p>如以下用来安装 <code>git</code>: <code>ansible-playbook playbook.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">git</span></span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240413213323748.png" alt="image-20240413213323748"></p>
<ul>
<li><p>多次执行时，<font color="red">按理会变成 ignored &#x3D; 1</font>，但仍会出现 <code>changed = 1</code>，可通过以下方式来解决，即预先判断，再执行安装操作。可能原因如下，但暂未找到官方文档</p>
<blockquote>
<p>GPT: 当使用 Ansible 执行 tdnf 安装软件时，即使软件已经安装过，<code>changed</code> 值仍然可能显示为1。这是因为 tdnf 模块在每次运行时检查软件包的状态，并记录状态更改，而不考虑软件是否已经安装</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例运行，单软件包</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">if</span> <span class="string">package</span> <span class="string">is</span> <span class="string">installed</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">tdnf</span> <span class="string">info</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">package_check</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">failed_when:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">package_check.rc</span> <span class="type">!=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240414112450696.png" alt="image-20240414112450696"></p>
</li>
</ul>
</li>
<li><p>安装多个软件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">tmux</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">git</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br></pre></td></tr></table></figure>

<h3 id="when"><a href="#when" class="headerlink" title="when"></a>when</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&#x27;VMware Photon OS&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>当 slave 存在多种架构的机器时，使用同一个模块安装软件不可行，此时使用 <code>when</code>来区分不同的 task &#x3D;&gt; <del><code>tdnf</code>不支持 <code>when</code></del>&#x3D;&gt; 缩进错了</p>
<p><img src="/tools/The-trick-of-ansible/image-20240414165032177.png" alt="image-20240414165032177"></p>
</li>
<li><p>缩进错误时，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">git</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&#x27;VMware Photon OS&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240414153839631.png" alt="image-20240414153839631"></p>
</li>
<li><p>比如，slave 机器存在  centos 和 Ubuntu 时，<code>apt</code>只适用于 Ubuntu，Centos 则需要使用 yum。可参见 <a target="_blank" rel="noopener" href="https://raymii.org/s/tutorials/Ansible_-_Only_if_on_specific_distribution_or_distribution_version.html">Ansible - Only do action if on specific distribution (Debian, Ubuntu, CentOS or RHEL) or distribution version (ubuntu precise, ubuntu trusty)</a></p>
<ul>
<li>系统版本可通过 <code>/etc/os-release</code>中 ID 确定</li>
<li>ansible_distribution 可通过 <code>ansible all -m gather_facts --limit 172.28.0.3 | grep ansible_distribution </code></li>
</ul>
</li>
</ul>
<h3 id="参数化"><a href="#参数化" class="headerlink" title="参数化"></a>参数化</h3><ul>
<li>将不同系统的安装都汇总到一个 task 中，简化操作（name 使用变量是因为不同系统的叫法不同，比如 apache2 和 httpd）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="comment"># package 根据系统自动选择, python3 好像需要指定管理工具，否则出现以下报错</span></span><br><span class="line"><span class="comment"># The Python 2 bindings for rpm are needed for this module. If you require Python 3 support use the `dnf` Ansible module instead.. The Python 2 yum module is needed for this module. If you require Python 3 support use the `dnf` Ansible module instead.&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; git_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; tmux_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory 即 之前的 ansible-example</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span> <span class="string">git_package=git</span> <span class="string">tmux_package=tmux</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span> <span class="string">git_package=git</span> <span class="string">tmux_package=tmux</span></span><br></pre></td></tr></table></figure>

<h3 id="分组-inventory"><a href="#分组-inventory" class="headerlink" title="分组 inventory"></a>分组 inventory</h3><ul>
<li>根据不同的作用，可以将 slave 机器进行分组，便于后续的管理，比如 webserver, db 等</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="comment"># package 根据系统自动选择</span></span><br><span class="line"><span class="comment"># 如果需要前置任务，可用 pre_tasks</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">tmux</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">tmux</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory 即 之前的 ansible-example</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span>                  </span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240414195721790.png" alt="image-20240414195721790"></p>
<h3 id="标签化-tags"><a href="#标签化-tags" class="headerlink" title="标签化 tags"></a>标签化 tags</h3><ul>
<li>给 task 添加 tag，然后配合 <code>ansible-playbook --tags [tag]</code>，即可执行对于 tag 的任务，多个 tag 使用 <code>--tags &quot;aa,bb&quot;</code></li>
<li><code>ansible-playbook --list-tags</code> 可查看已配置的 tag</li>
<li><code>always</code> 为保留字，不指定时，也会执行</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">tmux</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">tmux</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span>                  </span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<p><img src="/tools/The-trick-of-ansible/image-20240414201753872.png" alt="image-20240414201753872"></p>
<h2 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h2><h3 id="本地文件-copy"><a href="#本地文件-copy" class="headerlink" title="本地文件 copy"></a>本地文件 copy</h3><ul>
<li>通过 ansible 向 slave 下发文件，文件需要位于 <code>playbook.yml</code> 同级目录 <code>files</code>中（相对路径默认）&#x3D;&gt; <font color="red">实际是与 task 同级</font></li>
<li><code>dest</code> 末尾不带 <code>/</code>，即为复制过去后的名字，否则为路径</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">file</span> </span><br><span class="line">      <span class="attr">tags:</span> <span class="string">sometag</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">a.txt</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/root/hello</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">tmux</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">tmux</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span>                  </span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h3 id="网络文件-解压-unarchive"><a href="#网络文件-解压-unarchive" class="headerlink" title="网络文件 + 解压 unarchive"></a>网络文件 + 解压 unarchive</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">terraform</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">unarchive:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">https://releases.hashicorp.com/terraform/0.12.28/terraform_0.12.28_linux_amd64.zip</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/usr/local/bin</span></span><br><span class="line">        <span class="attr">remote_src:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span>                  </span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h3 id="服务管理-service"><a href="#服务管理-service" class="headerlink" title="服务管理 service"></a>服务管理 service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span>                  </span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h3 id="文件内容修改-lineinfile"><a href="#文件内容修改-lineinfile" class="headerlink" title="文件内容修改 lineinfile"></a>文件内容修改 lineinfile</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">email</span> <span class="string">address</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">lineinfile:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">        <span class="attr">regexp:</span> <span class="string">&#x27;^ServerAdmin&#x27;</span></span><br><span class="line">        <span class="attr">line:</span> <span class="string">ServerAdmin</span> <span class="string">abc@123.com</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">httpdsth</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">httpdsth.changed</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span>                  </span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><h3 id="新增用户-user"><a href="#新增用户-user" class="headerlink" title="新增用户 user"></a>新增用户 user</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">foo</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">        <span class="attr">groups:</span> <span class="string">root</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h3 id="用户权限-authorized-key"><a href="#用户权限-authorized-key" class="headerlink" title="用户权限 authorized_key"></a>用户权限 authorized_key</h3><ul>
<li>photon 需手动安装 sudo: <code>tdnf install sudo</code></li>
<li>使用前需安装: <code>ansible-galaxy collection install ansible.posix</code>。见 <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/authorized_key_module.html">ansible.posix.authorized_key module – Adds or removes an SSH authorized key</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">foo</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">        <span class="attr">groups:</span> <span class="string">root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">ssh</span> <span class="string">key</span> <span class="string">for</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">authorized_key:</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">foo</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">&quot;[replace by public key]&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">sudoers</span> <span class="string">file</span> <span class="string">for</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">sudoer_foo</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/sudoers.d/foo</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0440</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">      <span class="attr">tdnf:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># files/sudoer_foo</span></span><br><span class="line"><span class="string">foo</span> <span class="string">ALL=(ALL)</span> <span class="attr">NOPASSWD:</span> <span class="string">ALL</span></span><br></pre></td></tr></table></figure>

<h2 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h2><ul>
<li><p>与 <code>files</code> 同级创建 <code>roles</code>文件夹</p>
</li>
<li><p><code>roles</code> 每个文件夹代表一个 role，里面定义每个 role 的 tasks，如 <code>roles/web_servers/tasks/*.yml</code> 代表 web_servers 所需要执行的任务</p>
</li>
<li><p>tree</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── inventory</span><br><span class="line">├── playbook.yml</span><br><span class="line">└── roles</span><br><span class="line">    ├── base</span><br><span class="line">    │   └── tasks</span><br><span class="line">    │       └── main.yml</span><br><span class="line">    ├── db_servers</span><br><span class="line">    │   └── tasks</span><br><span class="line">    │       └── main.yml</span><br><span class="line">    └── web_servers</span><br><span class="line">        ├── files</span><br><span class="line">        │   └── a.txt</span><br><span class="line">        └── tasks</span><br><span class="line">            └── main.yml</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">base</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web_servers</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db_servers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">db_servers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># roles/base/tasks/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">tdnf:</span></span><br><span class="line">    <span class="attr">name:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># roles/web_servers/tasks</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">core</span></span><br><span class="line">  <span class="attr">tdnf:</span></span><br><span class="line">    <span class="attr">name:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">file</span> </span><br><span class="line">  <span class="attr">tags:</span> <span class="string">sometag</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">a.txt</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/root/hello</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># roles/db_servers/tasks</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">unzip</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">asdf</span></span><br><span class="line">  <span class="attr">tdnf:</span></span><br><span class="line">    <span class="attr">name:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inventory</span></span><br><span class="line">[<span class="string">web_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line">[<span class="string">db_servers</span>]</span><br><span class="line"><span class="number">172.28</span><span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h2 id="host-variables-and-handlers"><a href="#host-variables-and-handlers" class="headerlink" title="host variables and handlers"></a>host variables and handlers</h2><h3 id="host-vars"><a href="#host-vars" class="headerlink" title="host_vars"></a>host_vars</h3><ul>
<li><p>用来存放 slave host 配置信息的文件，即 <code>inventory</code> 中 IP 中对应机器的特殊配置，如安装的包名等，本质就是 <a href="###%E5%8F%82%E6%95%B0%E5%8C%96">参数化</a></p>
</li>
<li><p>tree</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── host_vars</span><br><span class="line">│   ├── 172.28.0.3.yml</span><br><span class="line">│   └── 172.28.0.4.yml</span><br><span class="line">├── inventory</span><br><span class="line">├── playbook.yml</span><br><span class="line">└── roles</span><br><span class="line">    ├── base</span><br><span class="line">    │   └── tasks</span><br><span class="line">    │       └── main.yml</span><br><span class="line">    ├── db_servers</span><br><span class="line">    │   └── tasks</span><br><span class="line">    │       └── main.yml</span><br><span class="line">    └── web_servers</span><br><span class="line">        ├── files</span><br><span class="line">        │   └── a.txt</span><br><span class="line">        └── tasks</span><br><span class="line">            └── main.yml</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="handlers"><a href="#handlers" class="headerlink" title="handlers"></a>handlers</h3><ul>
<li>register 配合 when 的优化，register 当有多个但是某个未变化时，when 中的 task 不会触发，而 handlers 是有变化即会触发任务</li>
</ul>
<p><img src="/tools/The-trick-of-ansible/image-20240421115559993.png" alt="image-20240421115559993"></p>
<p><img src="/tools/The-trick-of-ansible/image-20240421115625124.png" alt="image-20240421115625124"></p>
<p><img src="/tools/The-trick-of-ansible/image-20240421115737848.png" alt="image-20240421115737848"></p>
<ul>
<li><p>tree</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── host_vars</span><br><span class="line">│   ├── 172.28.0.3.yml</span><br><span class="line">│   └── 172.28.0.4.yml</span><br><span class="line">├── inventory</span><br><span class="line">├── playbook.yml</span><br><span class="line">└── roles</span><br><span class="line">    ├── base</span><br><span class="line">    │   └── tasks</span><br><span class="line">    │       └── main.yml</span><br><span class="line">    ├── db_servers</span><br><span class="line">    │   └── tasks</span><br><span class="line">    │       └── main.yml</span><br><span class="line">    └── web_servers</span><br><span class="line">        ├── files</span><br><span class="line">        │   └── a.txt</span><br><span class="line">        └── tasks</span><br><span class="line">            └── main.yml</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="template"><a href="#template" class="headerlink" title="template"></a>template</h2><ul>
<li><p>与 <code>roles/[role]/tasks</code> 同级别创建 templates 文件夹，用于存放模板文件。即 <code>*.j2</code> 文件</p>
</li>
<li><p>如下表示将 <code>sshd_config</code> 作为模板，保证在相同分发版本的不同 Linux 机器上配置保持一致。具体文件可见 <a target="_blank" rel="noopener" href="https://github.com/cv-programmer/ansible-learn">ansible-learn&#x2F;ansible-template</a></p>
<ol>
<li><p>配置模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># roles/base/templates/sshd_config_photon.j2</span><br><span class="line">AllowUsers &#123;&#123; ssh_user &#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加配置信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># host_vars/172.28.0.3.yml</span></span><br><span class="line"><span class="attr">ssh_user:</span> <span class="string">&quot;foo bar&quot;</span></span><br><span class="line"><span class="attr">ssh_template_file:</span> <span class="string">&quot;sshd_config_photon.j2&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 task，即指定从 template 生成文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># roles/base/tasks/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">generate</span> <span class="string">sshd_config</span> <span class="string">file</span> <span class="string">from</span> <span class="string">template</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ssh</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ssh_template_file &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/ssh/sshd_config</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart_sshd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 handlers</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># roles/base/handlers/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart_sshd</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sshd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h1 id="未解决"><a href="#未解决" class="headerlink" title="未解决"></a>未解决</h1><ul>
<li>目前 tdnf 安装软件时，不论是否已经安装过，都会返回 changed &#x3D; 1，看着是与 ansible 还没有兼容好，毕竟官网教程都搜不到 tdnf。相关回答如下<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible/issues/64963">dnf&#x2F;yum module not idempotent and reports changed for an installed package</a></li>
</ul>
</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=3RiVKs8GHYQ&list=PLT98CRl2KxKEUHie1m24-wkyHpEsa4Y70">Getting started with Ansible</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/index.html">Ansible community documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/">photon:3.0 doc</a></li>
<li><a target="_blank" rel="noopener" href="https://vmware.github.io/photon/docs-v5/">photon:5.0 doc</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">cv-programmer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://bh.ecel.top/tools/The-trick-of-ansible/">http://bh.ecel.top/tools/The-trick-of-ansible/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://bh.ecel.top" target="_blank">cv-programmer</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a></div><div class="post_share"><div class="social-share" data-image="/image/ansible.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/tutorial/Windows-install-docker-in-Windows/"><img class="prev-cover" src="/image/docker.jpg" onerror="onerror=null;src='/image/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【Windows】docker 安装</div></div></a></div><div class="next-post pull-right"><a href="/codeLang/Go-04-context/"><img class="next-cover" src="/image/go.jpeg" onerror="onerror=null;src='/image/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【Go】04-context</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/tutorial/Linux-bt-thinkphp/" title="【Linux】宝塔 + thinkphp"><img class="cover" src="/image/linux.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-01</div><div class="title">【Linux】宝塔 + thinkphp</div></div></a></div><div><a href="/tutorial/Linux-build-my-vps/" title="VPS"><img class="cover" src="/image/linux.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-26</div><div class="title">VPS</div></div></a></div><div><a href="/tutorial/Linux-install-Go-in-Linux/" title="【Linux】Go安装"><img class="cover" src="/image/linux.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">【Linux】Go安装</div></div></a></div><div><a href="/tutorial/Linux-install-MySQL-in-Linux/" title="【Linux】MySQL安装"><img class="cover" src="/image/linux.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-23</div><div class="title">【Linux】MySQL安装</div></div></a></div><div><a href="/tutorial/Linux-install-docker-in-Linux/" title="【Linux】docker安装"><img class="cover" src="/image/docker.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-16</div><div class="title">【Linux】docker安装</div></div></a></div><div><a href="/tutorial/Linux-install-kafka-in-Linux/" title="【Linux】kafka安装"><img class="cover" src="/image/linux.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-23</div><div class="title">【Linux】kafka安装</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/image/avatar.jpg" onerror="this.onerror=null;this.src='/image/friend_404.gif'" alt="avatar"/><div class="author-info__name">cv-programmer</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">91</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">124</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cv-programmer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cv-programmer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:usetologin@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E8%A6%81%E6%B1%82"><span class="toc-number">2.1.</span> <span class="toc-text">前置要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ansible-%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">Ansible 安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#playbook"><span class="toc-number">5.</span> <span class="toc-text">playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%85%E7%AE%A1%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">包管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD"><span class="toc-number">5.1.2.</span> <span class="toc-text">卸载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#when"><span class="toc-number">5.1.3.</span> <span class="toc-text">when</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%8C%96"><span class="toc-number">5.1.4.</span> <span class="toc-text">参数化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84-inventory"><span class="toc-number">5.1.5.</span> <span class="toc-text">分组 inventory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E5%8C%96-tags"><span class="toc-number">5.1.6.</span> <span class="toc-text">标签化 tags</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="toc-number">5.2.</span> <span class="toc-text">文件管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6-copy"><span class="toc-number">5.2.1.</span> <span class="toc-text">本地文件 copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6-%E8%A7%A3%E5%8E%8B-unarchive"><span class="toc-number">5.2.2.</span> <span class="toc-text">网络文件 + 解压 unarchive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86-service"><span class="toc-number">5.2.3.</span> <span class="toc-text">服务管理 service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E4%BF%AE%E6%94%B9-lineinfile"><span class="toc-number">5.2.4.</span> <span class="toc-text">文件内容修改 lineinfile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E7%94%A8%E6%88%B7-user"><span class="toc-number">5.3.1.</span> <span class="toc-text">新增用户 user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90-authorized-key"><span class="toc-number">5.3.2.</span> <span class="toc-text">用户权限 authorized_key</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roles"><span class="toc-number">5.4.</span> <span class="toc-text">roles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#host-variables-and-handlers"><span class="toc-number">5.5.</span> <span class="toc-text">host variables and handlers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#host-vars"><span class="toc-number">5.5.1.</span> <span class="toc-text">host_vars</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handlers"><span class="toc-number">5.5.2.</span> <span class="toc-text">handlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#template"><span class="toc-number">5.6.</span> <span class="toc-text">template</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%AA%E8%A7%A3%E5%86%B3"><span class="toc-number">6.</span> <span class="toc-text">未解决</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/tools/The-trick-of-ubuntu/" title="Ubuntu 常用技巧"><img src="/image/ubuntu.jpg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="Ubuntu 常用技巧"/></a><div class="content"><a class="title" href="/tools/The-trick-of-ubuntu/" title="Ubuntu 常用技巧">Ubuntu 常用技巧</a><time datetime="2025-05-11T03:17:02.000Z" title="发表于 2025-05-11 11:17:02">2025-05-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/ai/n8n/" title="工作流之 n8n"><img src="/image/n8n-logo.png" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="工作流之 n8n"/></a><div class="content"><a class="title" href="/ai/n8n/" title="工作流之 n8n">工作流之 n8n</a><time datetime="2025-04-04T14:04:06.000Z" title="发表于 2025-04-04 22:04:06">2025-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve"><img src="/image/go.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Go】07-调试工具 delve"/></a><div class="content"><a class="title" href="/codeLang/Go-07-delve/" title="【Go】07-调试工具 delve">【Go】07-调试工具 delve</a><time datetime="2025-03-01T14:41:51.000Z" title="发表于 2025-03-01 22:41:51">2025-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cloud/distribution-02-pull-cache/" title="【Distribution】02-mirror"><img src="/image/distribution-logo.svg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Distribution】02-mirror"/></a><div class="content"><a class="title" href="/cloud/distribution-02-pull-cache/" title="【Distribution】02-mirror">【Distribution】02-mirror</a><time datetime="2025-01-11T15:38:39.000Z" title="发表于 2025-01-11 23:38:39">2025-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/codeLang/Go-06-cobra/" title="【Go】06-Cobra"><img src="/image/go.jpeg" onerror="this.onerror=null;this.src='/image/404.jpg'" alt="【Go】06-Cobra"/></a><div class="content"><a class="title" href="/codeLang/Go-06-cobra/" title="【Go】06-Cobra">【Go】06-Cobra</a><time datetime="2025-01-11T13:55:29.000Z" title="发表于 2025-01-11 21:55:29">2025-01-11</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/image/ansible.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By cv-programmer</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>